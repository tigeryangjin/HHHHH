/*
电商销售，商品提报组：电商提报组，2017全年

供应商编号  
供应商名称  
物料大类  
商品编号  
商品名称
有效订购件数
有效订购金额
*/
DROP TABLE YJ_20180123_TMP;
DROP TABLE YJ_20180123_TMP1;
DROP TABLE YJ_20180123_TMP2;

--CREATE TABLE YJ_20180123_TMP AS
SELECT A.SUPPLIER_KEY SUPPLIER_CODE,
       A.GOODS_COMMON_KEY ITEM_CODE,
       SUM(A.NUMS) ORDER_QTY,
       SUM(A.ORDER_AMOUNT) ORDER_AMOUNT
  FROM FACT_GOODS_SALES A
 WHERE A.POSTING_DATE_KEY BETWEEN 20170101 AND 20171231
   AND EXISTS
 (SELECT 1
          FROM DIM_SALES_SOURCE B
         WHERE A.SALES_SOURCE_SECOND_KEY = B.SALES_SOURCE_SECOND_KEY
           AND B.SALES_SOURCE_KEY = 20)
   AND A.ORDER_STATE = 1
 GROUP BY A.SUPPLIER_KEY, A.GOODS_COMMON_KEY;

CREATE TABLE YJ_20180123_TMP1 AS
  SELECT TO_NUMBER(B.ZVENDOR) SUPPLIER_CODE, B.ZVEN_NAME SUPPLIER_NAME
    FROM ODSHAPPIGO.ODS_VENDOR B
   WHERE B.ZVENDOR =
         TRANSLATE(B.ZVENDOR,
                   '0' || TRANSLATE(B.ZVENDOR, '#0123456789', '#'),
                   '0');

CREATE TABLE YJ_20180123_TMP2 AS
  SELECT C.ITEM_CODE, C.MATDLT, C.GOODS_NAME
    FROM DIM_GOOD C
   WHERE C.CURRENT_FLG = 'Y'
     AND C.GROUP_ID = 2000;

WITH SALES AS
 (SELECT A.SUPPLIER_CODE, A.ITEM_CODE, A.ORDER_QTY, A.ORDER_AMOUNT
    FROM YJ_20180123_TMP A),
SUPP AS
 (SELECT B.SUPPLIER_CODE, B.SUPPLIER_NAME FROM YJ_20180123_TMP1 B),
ITEM AS
 (SELECT C.ITEM_CODE, C.MATDLT, C.GOODS_NAME FROM YJ_20180123_TMP2 C)
SELECT SUPP.SUPPLIER_CODE,
       SUPP.SUPPLIER_NAME,
       ITEM.MATDLT,
       ITEM.ITEM_CODE,
       ITEM.GOODS_NAME,
       SALES.ORDER_QTY,
       SALES.ORDER_AMOUNT
  FROM ITEM, SUPP, SALES
 WHERE SALES.SUPPLIER_CODE = SUPP.SUPPLIER_CODE
   AND SALES.ITEM_CODE = ITEM.ITEM_CODE
 ORDER BY SUPP.SUPPLIER_CODE, ITEM.ITEM_CODE;


