/*
关联算法
用户购买的商品之间频繁项集
*/

--1.购买记录基表
CREATE TABLE MEMBER_ITEM_APRIORI_BASE AS
SELECT DISTINCT A.MEMBER_KEY MEMBER_BP, A.GOODS_COMMON_KEY ITEM_CODE
  FROM FACT_GOODS_SALES A
 WHERE A.ORDER_STATE = 1
   AND A.GOODS_COMMON_KEY IS NOT NULL;

--2.确定商品范围
--2353786
SELECT COUNT(DISTINCT A.MEMBER_BP) FROM MEMBER_ITEM_APRIORI_BASE A;

SELECT A.ITEM_CODE, COUNT(1)
  FROM MEMBER_ITEM_APRIORI_BASE A
 GROUP BY A.ITEM_CODE
HAVING COUNT(1) > 10000
 ORDER BY COUNT(1) DESC;


--3.生成(A->B)项集
--3.1.部分商品的关联项集
SELECT A.MEMBER_BP, A.ITEM_CODE ITEM_CODE_A, B.ITEM_CODE ITEM_CODE_B
  FROM MEMBER_ITEM_APRIORI_BASE A, MEMBER_ITEM_APRIORI_BASE B
 WHERE A.MEMBER_BP = B.MEMBER_BP
   AND A.ITEM_CODE <> B.ITEM_CODE
   AND EXISTS (SELECT 1
          FROM (SELECT D.ITEM_CODE
                  FROM MEMBER_ITEM_APRIORI_BASE D
                 GROUP BY D.ITEM_CODE
                HAVING COUNT(1) > 10000) C
         WHERE A.ITEM_CODE = C.ITEM_CODE);

--3.2.全部商品的关联
SELECT E.ITEM_CODE_A, F.GOODS_NAME, E.ITEM_CODE_B, G.GOODS_NAME, E.BP_COUNT
  FROM (SELECT D.ITEM_CODE_A, D.ITEM_CODE_B, D.BP_COUNT
          FROM (SELECT C.ITEM_CODE_A,
                       C.ITEM_CODE_B,
                       COUNT(C.MEMBER_BP) BP_COUNT
                  FROM (SELECT A.MEMBER_BP,
                               A.ITEM_CODE ITEM_CODE_A,
                               B.ITEM_CODE ITEM_CODE_B
                          FROM MEMBER_ITEM_APRIORI_BASE A,
                               MEMBER_ITEM_APRIORI_BASE B
                         WHERE A.MEMBER_BP = B.MEMBER_BP
                           AND A.ITEM_CODE <> B.ITEM_CODE) C
                 GROUP BY C.ITEM_CODE_A, C.ITEM_CODE_B
                 ORDER BY COUNT(C.MEMBER_BP) DESC) D
         WHERE ROWNUM <= 100000) E,
       DIM_GOOD F,
       DIM_GOOD G
 WHERE E.ITEM_CODE_A = F.ITEM_CODE(+)
   AND E.ITEM_CODE_B = G.ITEM_CODE(+)
 ORDER BY E.BP_COUNT DESC;


--4.
SELECT *
  FROM (SELECT E.ITEM_CODE_A, E.ITEM_CODE_B, COUNT(E.MEMBER_BP) BP_COUNT
          FROM (SELECT A.MEMBER_BP,
                       A.ITEM_CODE ITEM_CODE_A,
                       B.ITEM_CODE ITEM_CODE_B
                  FROM MEMBER_ITEM_APRIORI_BASE A, MEMBER_ITEM_APRIORI_BASE B
                 WHERE A.MEMBER_BP = B.MEMBER_BP
                   AND A.ITEM_CODE <> B.ITEM_CODE
                   AND EXISTS (SELECT 1
                          FROM (SELECT D.ITEM_CODE
                                  FROM MEMBER_ITEM_APRIORI_BASE D
                                 GROUP BY D.ITEM_CODE
                                HAVING COUNT(1) > 10000) C
                         WHERE A.ITEM_CODE = C.ITEM_CODE)) E
         GROUP BY E.ITEM_CODE_A, E.ITEM_CODE_B
         ORDER BY COUNT(E.MEMBER_BP) DESC) F
 WHERE ROWNUM <= 100;
