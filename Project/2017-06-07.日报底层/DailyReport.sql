--********************************
--2017-06-26
--********************************
--加入20023，20024，20025，20027四个渠道
select * from DIM_SALES_SOURCE t order by 1,2,3,4,5,6 for update;

--重新刷新历史数据
DECLARE
  IN_DATE_INT NUMBER(8);
  IN_DATE     DATE;
  BEGIN_DATE  DATE := DATE '2016-01-01';
  END_DATE    DATE := DATE '2017-06-25';
BEGIN
  IN_DATE := BEGIN_DATE;
  WHILE IN_DATE <= END_DATE LOOP
    IN_DATE_INT := TO_CHAR(IN_DATE, 'YYYYMMDD');
    YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(IN_DATE_INT);
    IN_DATE := IN_DATE + 1;
  END LOOP;
END;
/

select count(distinct a.posting_date_key) /
       to_number(date '2017-06-26' - date '2016-01-01' + 1)
  from OPER_PRODUCT_DAILY_REPORT a
 order by 1;


--增加序列row_id
drop sequence OPER_PRODUCT_DAILY_REPORT_SEQ;
create sequence OPER_PRODUCT_DAILY_REPORT_SEQ
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;

DROP TABLE OPER_PRODUCT_DAILY_REPORT_TEST;
CREATE TABLE OPER_PRODUCT_DAILY_REPORT_TEST AS
SELECT OPER_PRODUCT_DAILY_REPORT_SEQ.NEXTVAL ROW_ID, B.*
  FROM (SELECT A.POSTING_DATE_KEY,
               A.SALES_SOURCE_NAME,
               A.SALES_SOURCE_SECOND_NAME,
               A.OWN_ACCOUNT,
               A.BRAND_NAME,
               A.TRAN_TYPE,
               A.TRAN_TYPE_NAME,
               A.ITEM_OR_GIFT,
               A.MATDLT,
               A.MATZLT,
               A.MATXLT,
               A.MD_PERSON,
               A.ITEM_CODE,
               A.GOODS_KEY,
               A.GOODS_NAME,
               A.TOTAL_ORDER_AMOUNT,
               A.NET_ORDER_AMOUNT,
               A.EFFECTIVE_ORDER_AMOUNT,
               A.CANCEL_ORDER_AMOUNT,
               A.REVERSE_ORDER_AMOUNT,
               A.REJECT_ORDER_AMOUNT,
               A.CANCEL_REVERSE_AMOUNT,
               A.CANCEL_REJECT_AMOUNT,
               A.TOTAL_SALES_AMOUNT,
               A.NET_SALES_AMOUNT,
               A.EFFECTIVE_SALES_AMOUNT,
               A.TOTAL_ORDER_MEMBER_COUNT,
               A.NET_ORDER_MEMBER_COUNT,
               A.EFFECTIVE_ORDER_MEMBER_COUNT,
               A.CANCEL_ORDER_MEMBER_COUNT,
               A.REVERSE_MEMBER_COUNT,
               A.REJECT_MEMBER_COUNT,
               A.CANCEL_REVERSE_MEMBER_COUNT,
               A.CANCEL_REJECT_MEMBER_COUNT,
               A.TOTAL_ORDER_COUNT,
               A.NET_ORDER_COUNT,
               A.EFFECTIVE_ORDER_COUNT,
               A.CANCEL_ORDER_COUNT,
               A.REVERSE_COUNT,
               A.REJECT_COUNT,
               A.CANCEL_REVERSE_COUNT,
               A.CANCEL_REJECT_COUNT,
               A.GROSS_PROFIT_AMOUNT,
               A.NET_PROFIT_AMOUNT,
               A.EFFECTIVE_PROFIT_AMOUNT,
               A.GROSS_PROFIT_RATE,
               A.NET_PROFIT_RATE,
               A.EFFECTIVE_PROFIT_RATE,
               A.TOTAL_ORDER_QTY,
               A.NET_ORDER_QTY,
               A.EFFECTIVE_ORDER_QTY,
               A.CANCEL_ORDER_QTY,
               A.REVERSE_QTY,
               A.REJECT_QTY,
               A.CANCEL_REVERSE_QTY,
               A.CANCEL_REJECT_QTY,
               A.NET_ORDER_CUST_PRICE,
               A.EFFECTIVE_ORDER_CUST_PRICE,
               A.NET_ORDER_UNIT_PRICE,
               A.EFFECTIVE_ORDER_UNIT_PRICE,
               A.TOTAL_PURCHASE_AMOUNT,
               A.NET_PURCHASE_AMOUNT,
               A.EFFECTIVE_PURCHASE_AMOUNT,
               A.PROFIT_AMOUNT,
               A.COUPONS_AMOUNT,
               A.FREIGHT_AMOUNT,
               A.PRODUCT_AVG_PRICE,
               A.REJECT_AMOUNT,
               A.LIVE_OR_REPLAY
          FROM OPER_PRODUCT_DAILY_REPORT A
         ORDER BY A.POSTING_DATE_KEY,
                  A.SALES_SOURCE_NAME,
                  A.SALES_SOURCE_SECOND_NAME,
                  A.TRAN_TYPE,
                  A.GOODS_KEY,
                  A.LIVE_OR_REPLAY) B;

TRUNCATE TABLE OPER_PRODUCT_DAILY_REPORT;
INSERT INTO OPER_PRODUCT_DAILY_REPORT
  (ROW_ID,
   POSTING_DATE_KEY,
   SALES_SOURCE_NAME,
   SALES_SOURCE_SECOND_NAME,
   OWN_ACCOUNT,
   BRAND_NAME,
   TRAN_TYPE,
   TRAN_TYPE_NAME,
   ITEM_OR_GIFT,
   MATDLT,
   MATZLT,
   MATXLT,
   MD_PERSON,
   ITEM_CODE,
   GOODS_KEY,
   GOODS_NAME,
   TOTAL_ORDER_AMOUNT,
   NET_ORDER_AMOUNT,
   EFFECTIVE_ORDER_AMOUNT,
   CANCEL_ORDER_AMOUNT,
   REVERSE_ORDER_AMOUNT,
   REJECT_ORDER_AMOUNT,
   CANCEL_REVERSE_AMOUNT,
   CANCEL_REJECT_AMOUNT,
   TOTAL_SALES_AMOUNT,
   NET_SALES_AMOUNT,
   EFFECTIVE_SALES_AMOUNT,
   TOTAL_ORDER_MEMBER_COUNT,
   NET_ORDER_MEMBER_COUNT,
   EFFECTIVE_ORDER_MEMBER_COUNT,
   CANCEL_ORDER_MEMBER_COUNT,
   REVERSE_MEMBER_COUNT,
   REJECT_MEMBER_COUNT,
   CANCEL_REVERSE_MEMBER_COUNT,
   CANCEL_REJECT_MEMBER_COUNT,
   TOTAL_ORDER_COUNT,
   NET_ORDER_COUNT,
   EFFECTIVE_ORDER_COUNT,
   CANCEL_ORDER_COUNT,
   REVERSE_COUNT,
   REJECT_COUNT,
   CANCEL_REVERSE_COUNT,
   CANCEL_REJECT_COUNT,
   GROSS_PROFIT_AMOUNT,
   NET_PROFIT_AMOUNT,
   EFFECTIVE_PROFIT_AMOUNT,
   GROSS_PROFIT_RATE,
   NET_PROFIT_RATE,
   EFFECTIVE_PROFIT_RATE,
   TOTAL_ORDER_QTY,
   NET_ORDER_QTY,
   EFFECTIVE_ORDER_QTY,
   CANCEL_ORDER_QTY,
   REVERSE_QTY,
   REJECT_QTY,
   CANCEL_REVERSE_QTY,
   CANCEL_REJECT_QTY,
   NET_ORDER_CUST_PRICE,
   EFFECTIVE_ORDER_CUST_PRICE,
   NET_ORDER_UNIT_PRICE,
   EFFECTIVE_ORDER_UNIT_PRICE,
   TOTAL_PURCHASE_AMOUNT,
   NET_PURCHASE_AMOUNT,
   EFFECTIVE_PURCHASE_AMOUNT,
   PROFIT_AMOUNT,
   COUPONS_AMOUNT,
   FREIGHT_AMOUNT,
   PRODUCT_AVG_PRICE,
   REJECT_AMOUNT,
   LIVE_OR_REPLAY)
  SELECT A.ROW_ID,
         A.POSTING_DATE_KEY,
         A.SALES_SOURCE_NAME,
         A.SALES_SOURCE_SECOND_NAME,
         A.OWN_ACCOUNT,
         A.BRAND_NAME,
         A.TRAN_TYPE,
         A.TRAN_TYPE_NAME,
         A.ITEM_OR_GIFT,
         A.MATDLT,
         A.MATZLT,
         A.MATXLT,
         A.MD_PERSON,
         A.ITEM_CODE,
         A.GOODS_KEY,
         A.GOODS_NAME,
         A.TOTAL_ORDER_AMOUNT,
         A.NET_ORDER_AMOUNT,
         A.EFFECTIVE_ORDER_AMOUNT,
         A.CANCEL_ORDER_AMOUNT,
         A.REVERSE_ORDER_AMOUNT,
         A.REJECT_ORDER_AMOUNT,
         A.CANCEL_REVERSE_AMOUNT,
         A.CANCEL_REJECT_AMOUNT,
         A.TOTAL_SALES_AMOUNT,
         A.NET_SALES_AMOUNT,
         A.EFFECTIVE_SALES_AMOUNT,
         A.TOTAL_ORDER_MEMBER_COUNT,
         A.NET_ORDER_MEMBER_COUNT,
         A.EFFECTIVE_ORDER_MEMBER_COUNT,
         A.CANCEL_ORDER_MEMBER_COUNT,
         A.REVERSE_MEMBER_COUNT,
         A.REJECT_MEMBER_COUNT,
         A.CANCEL_REVERSE_MEMBER_COUNT,
         A.CANCEL_REJECT_MEMBER_COUNT,
         A.TOTAL_ORDER_COUNT,
         A.NET_ORDER_COUNT,
         A.EFFECTIVE_ORDER_COUNT,
         A.CANCEL_ORDER_COUNT,
         A.REVERSE_COUNT,
         A.REJECT_COUNT,
         A.CANCEL_REVERSE_COUNT,
         A.CANCEL_REJECT_COUNT,
         A.GROSS_PROFIT_AMOUNT,
         A.NET_PROFIT_AMOUNT,
         A.EFFECTIVE_PROFIT_AMOUNT,
         A.GROSS_PROFIT_RATE,
         A.NET_PROFIT_RATE,
         A.EFFECTIVE_PROFIT_RATE,
         A.TOTAL_ORDER_QTY,
         A.NET_ORDER_QTY,
         A.EFFECTIVE_ORDER_QTY,
         A.CANCEL_ORDER_QTY,
         A.REVERSE_QTY,
         A.REJECT_QTY,
         A.CANCEL_REVERSE_QTY,
         A.CANCEL_REJECT_QTY,
         A.NET_ORDER_CUST_PRICE,
         A.EFFECTIVE_ORDER_CUST_PRICE,
         A.NET_ORDER_UNIT_PRICE,
         A.EFFECTIVE_ORDER_UNIT_PRICE,
         A.TOTAL_PURCHASE_AMOUNT,
         A.NET_PURCHASE_AMOUNT,
         A.EFFECTIVE_PURCHASE_AMOUNT,
         A.PROFIT_AMOUNT,
         A.COUPONS_AMOUNT,
         A.FREIGHT_AMOUNT,
         A.PRODUCT_AVG_PRICE,
         A.REJECT_AMOUNT,
         A.LIVE_OR_REPLAY
    FROM OPER_PRODUCT_DAILY_REPORT_TEST A;
		COMMIT;

SELECT A.POSTING_DATE_KEY, MIN(A.ROW_ID), MAX(A.ROW_ID)
  FROM OPER_PRODUCT_DAILY_REPORT A
 GROUP BY A.POSTING_DATE_KEY
 ORDER BY A.POSTING_DATE_KEY;


--刷新历史数据
DECLARE
  IN_DATE_INT NUMBER(8);
  IN_DATE     DATE;
  BEGIN_DATE  DATE := DATE '2016-01-01';
  END_DATE    DATE := DATE '2017-05-31';
BEGIN
  IN_DATE := BEGIN_DATE;
  WHILE IN_DATE <= END_DATE LOOP
    IN_DATE_INT := TO_CHAR(IN_DATE, 'YYYYMMDD');
    YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(IN_DATE_INT);
    IN_DATE := IN_DATE + 1;
  END LOOP;
END;
/

--TOOL
  SELECT *
    FROM ALL_ALL_TABLES T
   WHERE T.table_name LIKE '%GOOD%'
   ORDER BY T.table_name;
SELECT 'SELECT * FROM ' || T.owner || '.' || T.table_name ||
       ' WHERE ROWNUM<100;'
  FROM ALL_ALL_TABLES T
 WHERE T.owner = 'ODSHAPPIGO'
 ORDER BY T.table_name;
SELECT T.OWNER, T.name, T.TYPE, T.line, TRIM(T.TEXT) TEXT
  FROM ALL_SOURCE T
 WHERE UPPER(T.TEXT) LIKE '%DIM_GOODS%'
 ORDER BY TRIM(T.TEXT);
SELECT *
  FROM ALL_COL_COMMENTS T
 WHERE UPPER(T.COMMENTS) LIKE '%净%'
 ORDER BY T.COMMENTS;

--商品(根据group_name区分是否自营，电商提报组：自营，TV提报组：非自营)
SELECT DG.BRAND_NAME /*品牌*/,
       DG.MATDLT /*物料大类*/,
       DG.MATZLT /*物料中类*/,
       DG.MATXLT /*物料小类*/,
       DG.ITEM_CODE /*商品*/,
       DG.GOODS_COMMONID /*商品短编码*/,
       DG.GOODS_NAME /*商品名称*/,
       DECODE(DG.GROUP_ID, 2000, '自营', '非自营') OWN_ACCOUNT /*是否自营*/
  FROM DIM_GOOD DG;

--通路渠道
SELECT * FROM DIM_SALES_SOURCE;

--*************************************************************************************************************
--TOTAL
--*************************************************************************************************************
CREATE TABLE OPER_PRODUCT_DAILY_REPORT AS
  SELECT FO.POSTING_DATE_KEY /*过账日期key*/,
         DS.SALES_SOURCE_NAME /*销售一级组织名称*/,
         DS.SALES_SOURCE_SECOND_NAME /*销售二级组织名称*/,
         DG.OWN_ACCOUNT /*是否自营*/,
         DG.BRAND_NAME /*品牌*/,
         FO.TRAN_TYPE /*交易类型*/,
         FO.TRAN_TYPE_NAME /*交易类型说明*/,
         FO.ITEM_OR_GIFT /*主赠品*/,
         DG.MATDLT /*物料大类*/,
         DG.MATZLT /*物料中类*/,
         DG.MATXLT /*物料小类*/,
         FO.MD_PERSON /*MD工号*/,
         DG.ITEM_CODE /*商品短编码*/,
         FO.GOODS_KEY /*商品长编码*/,
         DG.GOODS_NAME /*商品名称*/,
         FO.TOTAL_ORDER_AMOUNT /*总订购金额*/,
         FO.NET_ORDER_AMOUNT /*净订购金额*/,
         FO.EFFECTIVE_ORDER_AMOUNT /*有效订购金额*/,
         FO.CANCEL_ORDER_AMOUNT /*取消订购金额*/,
         FO.REVERSE_ORDER_AMOUNT /*退货订购金额*/,
         FO.REJECT_ORDER_AMOUNT /*拒收订购金额*/,
         FO.CANCEL_REVERSE_AMOUNT /*退货取消订购金额*/,
         FO.CANCEL_REJECT_AMOUNT /*拒收取消订购金额*/,
         FO.TOTAL_SALES_AMOUNT /*总售价金额*/,
         FO.NET_SALES_AMOUNT /*净售价金额*/,
         FO.EFFECTIVE_SALES_AMOUNT /*有效售价金额*/,
         FO.TOTAL_ORDER_MEMBER_COUNT /*总订购人数*/,
         FO.NET_ORDER_MEMBER_COUNT /*净订购人数*/,
         FO.EFFECTIVE_ORDER_MEMBER_COUNT /*有效订购人数*/,
         FO.CANCEL_ORDER_MEMBER_COUNT /*取消订购人数*/,
         FO.REVERSE_MEMBER_COUNT /*退货订购人数*/,
         FO.REJECT_MEMBER_COUNT /*拒收订购人数*/,
         FO.CANCEL_REVERSE_MEMBER_COUNT /*退货取消订购人数*/,
         FO.CANCEL_REJECT_MEMBER_COUNT /*拒收取消订购人数*/,
         FO.TOTAL_ORDER_COUNT /*总订购单数*/,
         FO.NET_ORDER_COUNT /*净订购单数*/,
         FO.EFFECTIVE_ORDER_COUNT /*有效订购单数*/,
         FO.CANCEL_ORDER_COUNT /*取消订购单数*/,
         FO.REVERSE_COUNT /*退货订购单数*/,
         FO.REJECT_COUNT /*拒收订购单数*/,
         FO.CANCEL_REVERSE_COUNT /*退货取消订购件数*/,
         FO.CANCEL_REJECT_COUNT /*拒收取消订购件数*/,
         FO.GROSS_PROFIT_AMOUNT /*还原后总毛利额*/,
         FO.NET_PROFIT_AMOUNT /*还原后净毛利额*/,
         FO.EFFECTIVE_PROFIT_AMOUNT /*还原后有效毛利额*/,
         FO.GROSS_PROFIT_RATE /*还原后总毛利率*/,
         FO.NET_PROFIT_RATE /*还原后净毛利率*/,
         FO.EFFECTIVE_PROFIT_RATE /*还原后有效毛利率*/,
         FO.TOTAL_ORDER_QTY /*总订购数量*/,
         FO.NET_ORDER_QTY /*净订购数量*/,
         FO.EFFECTIVE_ORDER_QTY /*有效订购数量*/,
         FO.CANCEL_ORDER_QTY /*取消订购数量*/,
         FO.REVERSE_QTY /*退货订购数量*/,
         FO.REJECT_QTY /*拒收订购数量*/,
         FO.CANCEL_REVERSE_QTY /*退货取消订购数量*/,
         FO.CANCEL_REJECT_QTY /*拒收取消订购数量*/,
         FO.NET_ORDER_CUST_PRICE /*净订购客单价*/,
         FO.EFFECTIVE_ORDER_CUST_PRICE /*有效订购客单价*/,
         FO.NET_ORDER_UNIT_PRICE /*净订购件单价*/,
         FO.EFFECTIVE_ORDER_UNIT_PRICE /*有效订购件单价*/,
         FO.TOTAL_PURCHASE_AMOUNT /*总订购成本*/,
         FO.NET_PURCHASE_AMOUNT /*净订购成本*/,
         FO.EFFECTIVE_PURCHASE_AMOUNT /*有效订购成本*/,
         FO.PROFIT_AMOUNT /*折扣金额*/,
         FO.COUPONS_AMOUNT /*优惠券金额*/,
         FO.FREIGHT_AMOUNT /*运费*/,
         FO.PRODUCT_AVG_PRICE /*商品平均售价*/,
         FO.REJECT_AMOUNT /*拒退金额*/,
         FO.LIVE_OR_REPLAY /*直播重播*/
    FROM (SELECT OD2.GOODS_KEY /**/,
                 OD2.GOODS_COMMON_KEY /**/,
                 OD2.SALES_SOURCE_SECOND_KEY /*销售二级组织key*/,
                 OD2.ITEM_OR_GIFT /*主赠品*/,
                 OD2.TRAN_TYPE /*交易类型*/,
                 DECODE(OD2.TRAN_TYPE, 'TAN', '主品', 'REN', '主品退货') TRAN_TYPE_NAME /*交易类型说明*/,
                 OD2.MD_PERSON /*MD工号*/,
                 OD2.POSTING_DATE_KEY /*过账日期key*/,
                 OD2.LIVE_OR_REPLAY /*是否播出*/,
                 OD2.TOTAL_ORDER_AMOUNT /*总订购金额*/,
                 OD2.NET_ORDER_AMOUNT /*净订购金额*/,
                 OD2.EFFECTIVE_ORDER_AMOUNT /*有效订购金额*/,
                 OD2.CANCEL_ORDER_AMOUNT /*取消订购金额*/,
                 OD2.REVERSE_ORDER_AMOUNT /*退货订购金额*/,
                 OD2.REJECT_ORDER_AMOUNT /*拒收订购金额*/,
                 OD2.CANCEL_REVERSE_AMOUNT /*退货取消订购金额*/,
                 OD2.CANCEL_REJECT_AMOUNT /*拒收取消订购金额*/,
                 OD2.TOTAL_SALES_AMOUNT /*总售价金额*/,
                 OD2.NET_SALES_AMOUNT /*净售价金额*/,
                 OD2.EFFECTIVE_SALES_AMOUNT /*有效售价金额*/,
                 OD2.TOTAL_ORDER_MEMBER_COUNT /*总订购人数*/,
                 OD2.NET_ORDER_MEMBER_COUNT /*净订购人数*/,
                 OD2.EFFECTIVE_ORDER_MEMBER_COUNT /*有效订购人数*/,
                 OD2.CANCEL_ORDER_MEMBER_COUNT /*取消订购人数*/,
                 OD2.REVERSE_MEMBER_COUNT /*退货订购人数*/,
                 OD2.REJECT_MEMBER_COUNT /*拒收订购人数*/,
                 OD2.CANCEL_REVERSE_MEMBER_COUNT /*退货取消订购人数*/,
                 OD2.CANCEL_REJECT_MEMBER_COUNT /*拒收取消订购人数*/,
                 OD2.TOTAL_ORDER_COUNT /*总订购单数*/,
                 OD2.NET_ORDER_COUNT /*净订购单数*/,
                 OD2.EFFECTIVE_ORDER_COUNT /*有效订购单数*/,
                 OD2.CANCEL_ORDER_COUNT /*取消订购单数*/,
                 OD2.REVERSE_COUNT /*退货订购单数*/,
                 OD2.REJECT_COUNT /*拒收订购单数*/,
                 OD2.CANCEL_REVERSE_COUNT /*退货取消订购件数*/,
                 OD2.CANCEL_REJECT_COUNT /*拒收取消订购件数*/,
                 OD2.TOTAL_ORDER_AMOUNT - OD2.TOTAL_PURCHASE_AMOUNT GROSS_PROFIT_AMOUNT /*还原后总毛利额*/,
                 OD2.NET_ORDER_AMOUNT - OD2.NET_PURCHASE_AMOUNT NET_PROFIT_AMOUNT /*还原后净毛利额*/,
                 OD2.EFFECTIVE_ORDER_AMOUNT - OD2.EFFECTIVE_PURCHASE_AMOUNT EFFECTIVE_PROFIT_AMOUNT /*还原后有效毛利额*/,
                 DECODE(OD2.TOTAL_ORDER_AMOUNT,
                        0,
                        0,
                        (OD2.TOTAL_ORDER_AMOUNT - OD2.TOTAL_PURCHASE_AMOUNT) /
                        OD2.TOTAL_ORDER_AMOUNT) GROSS_PROFIT_RATE /*还原后总毛利率*/,
                 DECODE(OD2.NET_ORDER_AMOUNT,
                        0,
                        0,
                        (OD2.NET_ORDER_AMOUNT - OD2.NET_PURCHASE_AMOUNT) /
                        OD2.NET_ORDER_AMOUNT) NET_PROFIT_RATE /*还原后净毛利率*/,
                 DECODE(OD2.EFFECTIVE_ORDER_AMOUNT,
                        0,
                        0,
                        (OD2.EFFECTIVE_ORDER_AMOUNT -
                        OD2.EFFECTIVE_PURCHASE_AMOUNT) /
                        OD2.EFFECTIVE_ORDER_AMOUNT) EFFECTIVE_PROFIT_RATE /*还原后有效毛利率*/,
                 OD2.TOTAL_ORDER_QTY /*总订购数量*/,
                 OD2.NET_ORDER_QTY /*净订购数量*/,
                 OD2.EFFECTIVE_ORDER_QTY /*有效订购数量*/,
                 OD2.CANCEL_ORDER_QTY /*取消订购数量*/,
                 OD2.REVERSE_QTY /*退货订购数量*/,
                 OD2.REJECT_QTY /*拒收订购数量*/,
                 OD2.CANCEL_REVERSE_QTY /*退货取消订购数量*/,
                 OD2.CANCEL_REJECT_QTY /*拒收取消订购数量*/,
                 OD2.NET_ORDER_CUST_PRICE /*净订购客单价*/,
                 OD2.EFFECTIVE_ORDER_CUST_PRICE /*有效订购客单价*/,
                 OD2.NET_ORDER_UNIT_PRICE /*净订购件单价*/,
                 OD2.EFFECTIVE_ORDER_UNIT_PRICE /*有效订购件单价*/,
                 OD2.TOTAL_PURCHASE_AMOUNT /*总订购成本*/,
                 OD2.NET_PURCHASE_AMOUNT /*净订购成本*/,
                 OD2.EFFECTIVE_PURCHASE_AMOUNT /*有效订购成本*/,
                 OD2.PROFIT_AMOUNT /*折扣金额*/,
                 OD2.COUPONS_AMOUNT /*优惠券金额*/,
                 OD2.FREIGHT_AMOUNT /*运费*/,
                 OD2.PRODUCT_AVG_PRICE /*商品平均售价*/,
                 OD2.REJECT_AMOUNT /*拒退金额*/
            FROM (SELECT OD1.GOODS_KEY /**/,
                         OD1.GOODS_COMMON_KEY /**/,
                         OD1.SALES_SOURCE_SECOND_KEY /*销售二级组织key*/,
                         DECODE(OD1.TRAN_TYPE, 0, '主品', 1, '赠品') ITEM_OR_GIFT /*主赠品*/,
                         DECODE(OD1.CANCEL_STATE, 0, 'TAN', 1, 'REN') TRAN_TYPE /*交易类型*/,
                         OD1.MD_PERSON /*MD工号*/,
                         OD1.POSTING_DATE_KEY /*过账日期key*/,
                         DECODE(OD1.LIVE_STATE, 1, '直播', '重播') LIVE_OR_REPLAY /*是否播出*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.TOTAL_ORDER_AMOUNT,
                                    1,
                                    0)) TOTAL_ORDER_AMOUNT /*总订购金额*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.NET_ORDER_AMOUNT,
                                    1,
                                    -ABS(OD1.NET_ORDER_AMOUNT))) NET_ORDER_AMOUNT /*净订购金额*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.EFFECTIVE_ORDER_AMOUNT,
                                    1,
                                    -ABS(OD1.EFFECTIVE_ORDER_AMOUNT))) EFFECTIVE_ORDER_AMOUNT /*有效订购金额*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    0,
                                    1,
                                    OD1.TOTAL_ORDER_AMOUNT)) CANCEL_ORDER_AMOUNT /*取消订购金额*/,
                         0 REVERSE_ORDER_AMOUNT /*退货订购金额*/,
                         0 REJECT_ORDER_AMOUNT /*拒收订购金额*/,
                         0 CANCEL_REVERSE_AMOUNT /*退货取消订购金额*/,
                         0 CANCEL_REJECT_AMOUNT /*拒收取消订购金额*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.TOTAL_SALES_AMOUNT,
                                    1,
                                    0)) TOTAL_SALES_AMOUNT /*总售价金额*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.NET_SALES_AMOUNT,
                                    1,
                                    -ABS(OD1.NET_SALES_AMOUNT))) NET_SALES_AMOUNT /*净售价金额*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.EFFECTIVE_SALES_AMOUNT,
                                    1,
                                    -ABS(OD1.EFFECTIVE_SALES_AMOUNT))) EFFECTIVE_SALES_AMOUNT /*有效售价金额*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                COUNT(DISTINCT OD1.MEMBER_KEY),
                                1,
                                0) TOTAL_ORDER_MEMBER_COUNT /*总订购人数*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                COUNT(DISTINCT OD1.MEMBER_KEY),
                                1,
                                -COUNT(DISTINCT OD1.MEMBER_KEY)) NET_ORDER_MEMBER_COUNT /*净订购人数*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                COUNT(DISTINCT OD1.MEMBER_KEY),
                                1,
                                -COUNT(DISTINCT OD1.MEMBER_KEY)) EFFECTIVE_ORDER_MEMBER_COUNT /*有效订购人数*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                0,
                                1,
                                COUNT(DISTINCT OD1.MEMBER_KEY)) CANCEL_ORDER_MEMBER_COUNT /*取消订购人数*/,
                         0 REVERSE_MEMBER_COUNT /*退货订购人数*/,
                         0 REJECT_MEMBER_COUNT /*拒收订购人数*/,
                         0 CANCEL_REVERSE_MEMBER_COUNT /*退货取消订购人数*/,
                         0 CANCEL_REJECT_MEMBER_COUNT /*拒收取消订购人数*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                COUNT(DISTINCT OD1.ORDER_H_KEY),
                                1,
                                0) TOTAL_ORDER_COUNT /*总订购单数*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                COUNT(DISTINCT OD1.ORDER_H_KEY),
                                1,
                                -COUNT(DISTINCT OD1.ORDER_H_KEY)) NET_ORDER_COUNT /*净订购单数*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                COUNT(DISTINCT OD1.ORDER_H_KEY),
                                1,
                                -COUNT(DISTINCT OD1.ORDER_H_KEY)) EFFECTIVE_ORDER_COUNT /*有效订购单数*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                0,
                                1,
                                COUNT(DISTINCT OD1.ORDER_H_KEY)) CANCEL_ORDER_COUNT /*取消订购单数*/,
                         0 REVERSE_COUNT /*退货订购单数*/,
                         0 REJECT_COUNT /*拒收订购单数*/,
                         0 CANCEL_REVERSE_COUNT /*退货取消订购件数*/,
                         0 CANCEL_REJECT_COUNT /*拒收取消订购件数*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.TOTAL_ORDER_QTY,
                                    1,
                                    0)) TOTAL_ORDER_QTY /*总订购数量*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.NET_ORDER_QTY,
                                    1,
                                    -ABS(OD1.NET_ORDER_QTY))) NET_ORDER_QTY /*净订购数量*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.EFFECTIVE_ORDER_QTY,
                                    1,
                                    -ABS(OD1.EFFECTIVE_ORDER_QTY))) EFFECTIVE_ORDER_QTY /*有效订购数量*/,
                         DECODE(OD1.CANCEL_STATE,
                                0,
                                0,
                                1,
                                COUNT(DISTINCT OD1.TOTAL_ORDER_QTY)) CANCEL_ORDER_QTY /*取消订购数量*/,
                         0 REVERSE_QTY /*退货订购数量*/,
                         0 REJECT_QTY /*拒收订购数量*/,
                         0 CANCEL_REVERSE_QTY /*退货取消订购数量*/,
                         0 CANCEL_REJECT_QTY /*拒收取消订购数量*/,
                         SUM(OD1.NET_ORDER_AMOUNT) /
                         COUNT(DISTINCT OD1.MEMBER_KEY) NET_ORDER_CUST_PRICE /*净订购客单价*/,
                         SUM(OD1.EFFECTIVE_ORDER_AMOUNT) /
                         COUNT(DISTINCT OD1.MEMBER_KEY) EFFECTIVE_ORDER_CUST_PRICE /*有效订购客单价*/,
                         SUM(OD1.NET_ORDER_AMOUNT) / SUM(OD1.NET_ORDER_QTY) NET_ORDER_UNIT_PRICE /*净订购件单价*/,
                         SUM(OD1.EFFECTIVE_ORDER_AMOUNT) /
                         SUM(OD1.EFFECTIVE_ORDER_QTY) EFFECTIVE_ORDER_UNIT_PRICE /*有效订购件单价*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.TOTAL_PURCHASE_AMOUNT,
                                    1,
                                    0)) TOTAL_PURCHASE_AMOUNT /*总订购成本*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.NET_PURCHASE_AMOUNT,
                                    1,
                                    -ABS(OD1.NET_PURCHASE_AMOUNT))) NET_PURCHASE_AMOUNT /*净订购成本*/,
                         SUM(DECODE(OD1.CANCEL_STATE,
                                    0,
                                    OD1.EFFECTIVE_PURCHASE_AMOUNT,
                                    1,
                                    -ABS(OD1.NET_PURCHASE_AMOUNT))) EFFECTIVE_PURCHASE_AMOUNT /*有效订购成本*/,
                         SUM(OD1.PROFIT_AMOUNT) PROFIT_AMOUNT /*折扣金额*/,
                         SUM(OD1.COUPONS_AMOUNT) COUPONS_AMOUNT /*优惠券金额*/,
                         SUM(OD1.FREIGHT_AMOUNT) FREIGHT_AMOUNT /*运费*/,
                         SUM(OD1.TOTAL_SALES_AMOUNT) /
                         SUM(OD1.TOTAL_ORDER_QTY) PRODUCT_AVG_PRICE /*商品平均售价*/,
                         0 REJECT_AMOUNT /*拒退金额*/
                    FROM (SELECT OD.ORDER_KEY /*订单权责制*/,
                                 OD.ORDER_H_KEY /*订单发生制*/,
                                 OD.ORDER_DESC /*订购状态*/,
                                 OD.GOODS_KEY /*商品*/,
                                 OD.GOODS_COMMON_KEY /*商品短编码*/,
                                 OD.SALES_SOURCE_SECOND_KEY /*销售二级组织key*/,
                                 OD.TRAN_TYPE /*是否赠品标志*/,
                                 OD.TRAN_DESC /*交易类型*/,
                                 OD.MD_PERSON /*MD工号*/,
                                 OD.POSTING_DATE_KEY /*过账日期key*/,
                                 OD.LIVE_STATE /*是否直播*/,
                                 OD.REPLAY_STATE /*是否重播*/,
                                 OD.ORDER_STATE /*订单状态*/,
                                 OD.CANCEL_STATE /*取消状态*/,
                                 OD.MEMBER_KEY /*会员key*/,
                                 OD.NUMS                    TOTAL_ORDER_QTY /*总订购数量*/,
                                 OD.NUMS                    NET_ORDER_QTY /*净订购数量*/,
                                 OD.NUMS                    EFFECTIVE_ORDER_QTY /*有效订购数量*/,
                                 OD.ORDER_AMOUNT            TOTAL_ORDER_AMOUNT /*总订单金额*/,
                                 OD.ORDER_AMOUNT            NET_ORDER_AMOUNT /*净订购金额*/,
                                 OD.ORDER_AMOUNT            EFFECTIVE_ORDER_AMOUNT /*有效订购金额*/,
                                 OD.SALES_AMOUNT            TOTAL_SALES_AMOUNT /*总售价金额*/,
                                 OD.SALES_AMOUNT            NET_SALES_AMOUNT /*净订购金额*/,
                                 OD.SALES_AMOUNT            EFFECTIVE_SALES_AMOUNT /*有效订购金额*/,
                                 OD.UNIT_PRICE /*单个商品售价*/,
                                 OD.COST_PRICE /*商品单件成本*/,
                                 OD.FREIGHT_AMOUNT /*运费*/,
                                 OD.COUPONS_PRICE           COUPONS_AMOUNT /*优惠券金额*/,
                                 OD.PURCHASE_AMOUNT         TOTAL_PURCHASE_AMOUNT /*总订购成本*/,
                                 OD.PURCHASE_AMOUNT         NET_PURCHASE_AMOUNT /*净订购成本*/,
                                 OD.PURCHASE_AMOUNT         EFFECTIVE_PURCHASE_AMOUNT /*有效订购成本*/,
                                 OD.PROFIT_AMOUNT /*折扣金额*/
                            FROM FACT_GOODS_SALES OD
                           WHERE OD.POSTING_DATE_KEY = 20170601
                             AND OD.TRAN_TYPE = 0 /*只显示主品*/
                          ) OD1
                   GROUP BY OD1.GOODS_KEY,
                            OD1.GOODS_COMMON_KEY,
                            OD1.SALES_SOURCE_SECOND_KEY,
                            DECODE(OD1.TRAN_TYPE, 0, '主品', 1, '赠品'),
                            DECODE(OD1.CANCEL_STATE, 0, 'TAN', 1, 'REN'),
                            OD1.MD_PERSON,
                            OD1.POSTING_DATE_KEY,
                            DECODE(OD1.LIVE_STATE, 1, '直播', '重播'),
                            OD1.CANCEL_STATE) OD2
          UNION ALL
          --*************************************************************************************
          --REVERSE
          --*************************************************************************************
          SELECT RD2.GOODS_KEY,
                 RD2.GOODS_COMMON_KEY,
                 RD2.SALES_SOURCE_SECOND_KEY /*销售二级组织key*/,
                 '主品' ITEM_OR_GIFT /*主赠品*/,
                 RD2.TRAN_TYPE /*交易类型*/,
                 DECODE(RD2.TRAN_TYPE, 'TAN', '主品', 'REN', '主品退货') TRAN_TYPE_NAME /*交易类型说明*/,
                 RD2.MD_PERSON /*MD员工号*/,
                 RD2.POSTING_DATE_KEY /*过账日期*/,
                 RD2.LIVE_OR_REPLAY /*直重播*/,
                 RD2.TOTAL_ORDER_AMOUNT /*总订购金额*/,
                 RD2.NET_ORDER_AMOUNT /*净订购金额*/,
                 -RD2.REVERSE_ORDER_AMOUNT - RD2.REJECT_ORDER_AMOUNT +
                 RD2.CANCEL_REVERSE_AMOUNT + RD2.CANCEL_REJECT_AMOUNT EFFECTIVE_ORDER_AMOUNT /*有效订购金额= -退货订购金额-拒收订购金额+退货取消订购金额+拒收取消订购金额*/,
                 RD2.CANCEL_ORDER_AMOUNT /*取消订购金额*/,
                 RD2.REVERSE_ORDER_AMOUNT /*退货订购金额*/,
                 RD2.REJECT_ORDER_AMOUNT /*拒收订购金额*/,
                 RD2.CANCEL_REVERSE_AMOUNT /*退货取消订购金额*/,
                 RD2.CANCEL_REJECT_AMOUNT /*拒收取消订购金额*/,
                 RD2.TOTAL_SALES_AMOUNT /*总售价金额*/,
                 RD2.NET_SALES_AMOUNT /*净售价金额*/,
                 -RD2.REVERSE_SALES_AMOUNT - RD2.REJECT_SALES_AMOUNT +
                 RD2.CANCEL_REVERSE_SALES_AMOUNT +
                 RD2.CANCEL_REJECT_SALES_AMOUNT EFFECTIVE_SALES_AMOUNT /*有效售价金额= -退货售价金额-拒收售价金额+退货取消售价金额+拒收取消售价金额*/,
                 RD2.TOTAL_ORDER_MEMBER_COUNT /*总订购人数*/,
                 RD2.NET_ORDER_MEMBER_COUNT /*净订购人数*/,
                 -RD2.REVERSE_MEMBER_COUNT - RD2.REJECT_MEMBER_COUNT +
                 RD2.CANCEL_REVERSE_MEMBER_COUNT +
                 RD2.CANCEL_REJECT_MEMBER_COUNT EFFECTIVE_ORDER_MEMBER_COUNT /*有效订购人数=-退货订购人数-拒收订购人数+退货取消订购人数+拒收取消订购人数*/,
                 RD2.CANCEL_ORDER_MEMBER_COUNT /*取消订购人数*/,
                 RD2.REVERSE_MEMBER_COUNT /*退货订购人数*/,
                 RD2.REJECT_MEMBER_COUNT /*拒收订购人数*/,
                 RD2.CANCEL_REVERSE_MEMBER_COUNT /*退货取消订购人数*/,
                 RD2.CANCEL_REJECT_MEMBER_COUNT /*拒收取消订购人数*/,
                 RD2.TOTAL_ORDER_COUNT /*总订购单数*/,
                 RD2.NET_ORDER_COUNT /*净订购单数*/,
                 -RD2.REVERSE_COUNT - RD2.REJECT_COUNT +
                 RD2.CANCEL_REVERSE_COUNT + RD2.CANCEL_REJECT_COUNT EFFECTIVE_ORDER_COUNT /*有效订购单数*/,
                 RD2.CANCEL_ORDER_COUNT /*取消订购单数*/,
                 RD2.REVERSE_COUNT /*退货订购单数*/,
                 RD2.REJECT_COUNT /*拒收订购单数*/,
                 RD2.CANCEL_REVERSE_COUNT /*退货取消订购单数*/,
                 RD2.CANCEL_REJECT_COUNT /*拒收取消订购单数*/,
                 RD2.GROSS_PROFIT_AMOUNT /*还原后总毛利额*/,
                 RD2.NET_PROFIT_AMOUNT /*还原后净毛利额*/,
                 (-RD2.REVERSE_SALES_AMOUNT - RD2.REJECT_SALES_AMOUNT +
                 RD2.CANCEL_REVERSE_SALES_AMOUNT +
                 RD2.CANCEL_REJECT_SALES_AMOUNT) -
                 (-RD2.REVERSE_PURCHASE_AMOUNT - RD2.REJECT_PURCHASE_AMOUNT +
                 RD2.CANCEL_REVERSE_PURCHASE_AMOUNT +
                 RD2.CANCEL_REJECT_PURCHASE_AMOUNT) EFFECTIVE_PROFIT_AMOUNT /*还原后有效毛利额*/,
                 RD2.GROSS_PROFIT_RATE /*还原后总毛利率*/,
                 RD2.NET_PROFIT_RATE /*还原后净毛利率*/,
                 DECODE(-RD2.REVERSE_ORDER_AMOUNT - RD2.REJECT_ORDER_AMOUNT +
                        RD2.CANCEL_REVERSE_AMOUNT + RD2.CANCEL_REJECT_AMOUNT,
                        0,
                        0,
                        ((-RD2.REVERSE_SALES_AMOUNT - RD2.REJECT_SALES_AMOUNT +
                        RD2.CANCEL_REVERSE_SALES_AMOUNT +
                        RD2.CANCEL_REJECT_SALES_AMOUNT) -
                        (-RD2.REVERSE_PURCHASE_AMOUNT -
                        RD2.REJECT_PURCHASE_AMOUNT +
                        RD2.CANCEL_REVERSE_PURCHASE_AMOUNT +
                        RD2.CANCEL_REJECT_PURCHASE_AMOUNT)) /
                        (-RD2.REVERSE_ORDER_AMOUNT - RD2.REJECT_ORDER_AMOUNT +
                        RD2.CANCEL_REVERSE_AMOUNT + RD2.CANCEL_REJECT_AMOUNT)) EFFECTIVE_PROFIT_RATE /*还原后有效毛利率*/,
                 RD2.TOTAL_ORDER_QTY /*总订购数量*/,
                 RD2.NET_ORDER_QTY /*净订购数量*/,
                 -RD2.REVERSE_QTY - RD2.REJECT_QTY + RD2.CANCEL_REVERSE_QTY +
                 RD2.CANCEL_REJECT_QTY EFFECTIVE_ORDER_QTY /*有效订购数量= -退货订购数量-拒收订购数量+退货取消订购数量+拒收取消订购数量*/,
                 RD2.CANCEL_ORDER_QTY /*取消订购数量*/,
                 RD2.REVERSE_QTY /*退货订购数量*/,
                 RD2.REJECT_QTY /*拒收订购数量*/,
                 RD2.CANCEL_REVERSE_QTY /*退货取消订购数量*/,
                 RD2.CANCEL_REJECT_QTY /*拒收取消订购数量*/,
                 RD2.NET_ORDER_CUST_PRICE /*净订购客单价*/,
                 DECODE(-RD2.REVERSE_MEMBER_COUNT - RD2.REJECT_MEMBER_COUNT +
                        RD2.CANCEL_REVERSE_MEMBER_COUNT +
                        RD2.CANCEL_REJECT_MEMBER_COUNT,
                        0,
                        0,
                        (-RD2.REVERSE_ORDER_AMOUNT - RD2.REJECT_ORDER_AMOUNT +
                        RD2.CANCEL_REVERSE_AMOUNT + RD2.CANCEL_REJECT_AMOUNT) /
                        (-RD2.REVERSE_MEMBER_COUNT - RD2.REJECT_MEMBER_COUNT +
                        RD2.CANCEL_REVERSE_MEMBER_COUNT +
                        RD2.CANCEL_REJECT_MEMBER_COUNT)) EFFECTIVE_ORDER_CUST_PRICE /*有效订购客单价*/,
                 RD2.NET_ORDER_UNIT_PRICE /*净订购件单价*/,
                 DECODE(-RD2.REVERSE_QTY - RD2.REJECT_QTY +
                        RD2.CANCEL_REVERSE_QTY + RD2.CANCEL_REJECT_QTY,
                        0,
                        0,
                        (-RD2.REVERSE_ORDER_AMOUNT - RD2.REJECT_ORDER_AMOUNT +
                        RD2.CANCEL_REVERSE_AMOUNT + RD2.CANCEL_REJECT_AMOUNT) /
                        (-RD2.REVERSE_QTY - RD2.REJECT_QTY +
                        RD2.CANCEL_REVERSE_QTY + RD2.CANCEL_REJECT_QTY)) EFFECTIVE_ORDER_UNIT_PRICE /*有效订购件单价*/,
                 0 TOTAL_PURCHASE_AMOUNT /*总订购成本*/,
                 0 NET_PURCHASE_AMOUNT /*净订购成本*/,
                 -RD2.REVERSE_PURCHASE_AMOUNT - RD2.REJECT_PURCHASE_AMOUNT +
                 RD2.CANCEL_REVERSE_PURCHASE_AMOUNT +
                 RD2.CANCEL_REJECT_PURCHASE_AMOUNT EFFECTIVE_PURCHASE_AMOUNT /*有效订购成本=-退货订购成本-拒收订购成本+退货取消订购成本+拒收取消订购成本*/,
                 RD2.PROFIT_AMOUNT PROFIT_AMOUNT /*折扣金额*/,
                 RD2.COUPONS_AMOUNT COUPONS_AMOUNT /*优惠券金额*/,
                 RD2.FREIGHT_AMOUNT FREIGHT_AMOUNT /*运费*/,
                 0 PRODUCT_AVG_PRICE /*商品平均售价*/,
                 - (-RD2.REVERSE_ORDER_AMOUNT - RD2.REJECT_ORDER_AMOUNT +
                   RD2.CANCEL_REVERSE_AMOUNT + RD2.CANCEL_REJECT_AMOUNT) REJECT_AMOUNT /*拒退金额*/
            FROM (SELECT RD1.GOODS_KEY,
                         RD1.GOODS_COMMON_KEY,
                         RD1.SALES_SOURCE_SECOND_KEY /*销售二级组织key*/,
                         RD1.TRAN_DESC TRAN_TYPE /*交易类型*/,
                         RD1.MD_PERSON /*MD员工号*/,
                         RD1.POSTING_DATE_KEY /*过账日期*/,
                         DECODE(RD1.LIVE_STATE, 1, '直播', '重播') LIVE_OR_REPLAY,
                         0 TOTAL_ORDER_AMOUNT /*总订购金额*/,
                         0 NET_ORDER_AMOUNT /*净订购金额*/,
                         0 CANCEL_ORDER_AMOUNT /*取消订购金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.ORDER_AMOUNT,
                                           30,
                                           RD1.ORDER_AMOUNT,
                                           20,
                                           0),
                                    0)) REVERSE_ORDER_AMOUNT /*退货订购金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON,
                                           20,
                                           RD1.ORDER_AMOUNT,
                                           0),
                                    0)) REJECT_ORDER_AMOUNT /*拒收订购金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.ORDER_AMOUNT,
                                           30,
                                           RD1.ORDER_AMOUNT,
                                           20,
                                           0),
                                    0)) CANCEL_REVERSE_AMOUNT /*退货取消订购金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON,
                                           20,
                                           RD1.ORDER_AMOUNT,
                                           0),
                                    0)) CANCEL_REJECT_AMOUNT /*拒收取消订购金额*/,
                         0 TOTAL_SALES_AMOUNT /*总售价金额*/,
                         0 NET_SALES_AMOUNT /*净售价金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.SALES_AMOUNT,
                                           30,
                                           RD1.SALES_AMOUNT,
                                           20,
                                           0),
                                    0)) REVERSE_SALES_AMOUNT /*退货售价金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON,
                                           20,
                                           RD1.SALES_AMOUNT,
                                           0),
                                    0)) REJECT_SALES_AMOUNT /*拒收售价金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.SALES_AMOUNT,
                                           30,
                                           RD1.SALES_AMOUNT,
                                           20,
                                           0),
                                    0)) CANCEL_REVERSE_SALES_AMOUNT /*退货取消售价金额*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON,
                                           20,
                                           RD1.SALES_AMOUNT,
                                           0),
                                    0)) CANCEL_REJECT_SALES_AMOUNT /*拒收取消售价金额*/,
                         0 TOTAL_ORDER_MEMBER_COUNT /*总订购人数*/,
                         0 NET_ORDER_MEMBER_COUNT /*净订购人数*/,
                         0 CANCEL_ORDER_MEMBER_COUNT /*取消订购人数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      0,
                                      DECODE(RD1.CANCEL_REASON,
                                             10,
                                             RD1.MEMBER_KEY,
                                             30,
                                             RD1.MEMBER_KEY,
                                             NULL),
                                      0)) REVERSE_MEMBER_COUNT /*退货订购人数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      0,
                                      DECODE(RD1.CANCEL_REASON,
                                             20,
                                             RD1.MEMBER_KEY,
                                             NULL),
                                      0)) REJECT_MEMBER_COUNT /*拒收订购人数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      1,
                                      DECODE(RD1.CANCEL_REASON,
                                             10,
                                             RD1.MEMBER_KEY,
                                             30,
                                             RD1.MEMBER_KEY,
                                             NULL),
                                      0)) CANCEL_REVERSE_MEMBER_COUNT /*退货取消订购人数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      1,
                                      DECODE(RD1.CANCEL_REASON,
                                             20,
                                             RD1.MEMBER_KEY,
                                             NULL),
                                      0)) CANCEL_REJECT_MEMBER_COUNT /*拒收取消订购人数*/,
                         0 TOTAL_ORDER_COUNT /*总订购单数*/,
                         0 NET_ORDER_COUNT /*净订购单数*/,
                         0 CANCEL_ORDER_COUNT /*取消订购单数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      0,
                                      DECODE(RD1.CANCEL_REASON,
                                             10,
                                             RD1.ORDER_H_KEY,
                                             30,
                                             RD1.ORDER_H_KEY,
                                             NULL),
                                      0)) REVERSE_COUNT /*退货订购单数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      0,
                                      DECODE(RD1.CANCEL_REASON,
                                             20,
                                             RD1.ORDER_H_KEY,
                                             NULL),
                                      0)) REJECT_COUNT /*拒收订购单数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      1,
                                      DECODE(RD1.CANCEL_REASON,
                                             10,
                                             RD1.ORDER_H_KEY,
                                             30,
                                             RD1.ORDER_H_KEY,
                                             NULL),
                                      0)) CANCEL_REVERSE_COUNT /*退货取消订购单数*/,
                         COUNT(DISTINCT DECODE(RD1.CANCEL_STATE,
                                      1,
                                      DECODE(RD1.CANCEL_REASON,
                                             20,
                                             RD1.ORDER_H_KEY,
                                             NULL),
                                      0)) CANCEL_REJECT_COUNT /*拒收取消订购单数*/,
                         0 GROSS_PROFIT_AMOUNT /*还原后总毛利额*/,
                         0 NET_PROFIT_AMOUNT /*还原后净毛利额*/,
                         0 GROSS_PROFIT_RATE /*还原后总毛利率*/,
                         0 NET_PROFIT_RATE /*还原后净毛利率*/,
                         0 TOTAL_ORDER_QTY /*总订购数量*/,
                         0 NET_ORDER_QTY /*净订购数量*/,
                         0 CANCEL_ORDER_QTY /*取消订购数量*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.NUMS,
                                           30,
                                           RD1.NUMS,
                                           20,
                                           0),
                                    0)) REVERSE_QTY /*退货订购数量*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON, 20, RD1.NUMS, 0),
                                    0)) REJECT_QTY /*拒收订购数量*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.NUMS,
                                           30,
                                           RD1.NUMS,
                                           20,
                                           0),
                                    0)) CANCEL_REVERSE_QTY /*退货取消订购数量*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON, 20, RD1.NUMS, 0),
                                    0)) CANCEL_REJECT_QTY /*拒收取消订购数量*/,
                         0 NET_ORDER_CUST_PRICE /*净订购客单价*/,
                         0 NET_ORDER_UNIT_PRICE /*净订购件单价*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.PURCHASE_AMOUNT,
                                           30,
                                           RD1.PURCHASE_AMOUNT,
                                           20,
                                           0),
                                    0)) REVERSE_PURCHASE_AMOUNT /*退货订购成本*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    0,
                                    DECODE(RD1.CANCEL_REASON,
                                           20,
                                           RD1.PURCHASE_AMOUNT,
                                           0),
                                    0)) REJECT_PURCHASE_AMOUNT /*拒收订购成本*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON,
                                           10,
                                           RD1.PURCHASE_AMOUNT,
                                           30,
                                           RD1.PURCHASE_AMOUNT,
                                           20,
                                           0),
                                    0)) CANCEL_REVERSE_PURCHASE_AMOUNT /*退货取消订购成本*/,
                         SUM(DECODE(RD1.CANCEL_STATE,
                                    1,
                                    DECODE(RD1.CANCEL_REASON,
                                           20,
                                           RD1.PURCHASE_AMOUNT,
                                           0),
                                    0)) CANCEL_REJECT_PURCHASE_AMOUNT /*拒收取消订购成本*/,
                         SUM(RD1.PROFIT_AMOUNT) PROFIT_AMOUNT /*折扣金额*/,
                         SUM(RD1.COUPONS_AMOUNT) COUPONS_AMOUNT /*优惠券金额*/,
                         SUM(RD1.FREIGHT_AMOUNT) FREIGHT_AMOUNT /*运费*/
                    FROM (SELECT RD.ORDER_KEY /*订单权责制*/,
                                 RD.ORDER_H_KEY /*订单发生制*/,
                                 RD.CANCEL_REASON /*退货类型*/,
                                 RD.CANCEL_STATE /*退货状态*/,
                                 RD.GOODS_KEY /*商品*/,
                                 RD.GOODS_COMMON_KEY /*商品短编码*/,
                                 RD.SALES_SOURCE_SECOND_KEY /*销售二级组织key*/,
                                 RD.TRAN_TYPE /*是否赠品标志*/,
                                 RD.TRAN_DESC /*交易类型*/,
                                 RD.MD_PERSON /*MD工号*/,
                                 RD.POSTING_DATE_KEY /*过账日期key*/,
                                 RD.LIVE_STATE /*是否直播*/,
                                 RD.REPLAY_STATE /*是否重播*/,
                                 RD.MEMBER_KEY /*会员key*/,
                                 RD.ORDER_AMOUNT /*退货订购金额*/,
                                 RD.NUMS /*总订购数量*/,
                                 RD.SALES_AMOUNT /*总售价金额*/,
                                 RD.UNIT_PRICE /*单个商品售价*/,
                                 RD.COST_PRICE /*商品单件成本*/,
                                 RD.FREIGHT_AMOUNT /*运费*/,
                                 RD.COUPONS_PRICE COUPONS_AMOUNT /*优惠券金额*/,
                                 RD.PURCHASE_AMOUNT /*总订购成本*/,
                                 RD.PROFIT_AMOUNT /*折扣金额*/
                            FROM FACT_GOODS_SALES_REVERSE RD
                           WHERE RD.POSTING_DATE_KEY = 20170601
                             AND RD.CANCEL_REASON IN (10, 20, 30)
                             AND RD.TRAN_DESC = 'REN') RD1
                   GROUP BY RD1.GOODS_KEY,
                            RD1.GOODS_COMMON_KEY,
                            RD1.SALES_SOURCE_SECOND_KEY,
                            RD1.TRAN_DESC,
                            RD1.MD_PERSON,
                            RD1.POSTING_DATE_KEY,
                            DECODE(RD1.LIVE_STATE, 1, '直播', '重播')) RD2) FO,
         (SELECT DG.BRAND_NAME /*品牌*/,
                 DG.MATDLT /*物料大类*/,
                 DG.MATZLT /*物料中类*/,
                 DG.MATXLT /*物料小类*/,
                 DG.ITEM_CODE /*商品*/,
                 DG.GOODS_COMMONID /*商品短编码*/,
                 DG.GOODS_NAME /*商品名称*/,
                 DECODE(DG.GROUP_ID, 2000, '自营', '非自营') OWN_ACCOUNT /*是否自营*/
            FROM DIM_GOOD DG) DG,
         (SELECT * FROM DIM_SALES_SOURCE) DS
   WHERE FO.GOODS_COMMON_KEY = DG.ITEM_CODE
     AND FO.SALES_SOURCE_SECOND_KEY = DS.SALES_SOURCE_SECOND_KEY;

/*Fact_Order_Reverse  fact_goods_sales_reverse  fact_goods_sales  fact_order*/

--TMP
