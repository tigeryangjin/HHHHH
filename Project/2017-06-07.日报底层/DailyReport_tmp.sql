--20170601,item:217761,订单号:5202127076,2017-05-25过账,2017-06-01取消订购,渠道20021 取消订购1968元,在excel中没有体现。CANCEL_BEFORE_STATE=0
--20170601,item:185186,订单号:5202215847,2017-05-31过账,2017-06-01取消订购,渠道20021 取消订购289元,在excel中有体现。CANCEL_BEFORE_STATE=1
--结论：发货前取消的订单需要虚拟记录，而发货后取消的订购，本身就已经进入拒退流程了。

SELECT * FROM FACT_GOODS_SALES T WHERE T.ORDER_KEY = 5202127076;
SELECT * FROM FACT_GOODS_SALES T WHERE T.ORDER_KEY = 5202215847 AND T.GOODS_COMMON_KEY=185186;

SELECT * FROM FACT_GOODS_SALES_REVERSE T WHERE T.ORDER_KEY=5202127076;
SELECT * FROM FACT_GOODS_SALES_REVERSE T WHERE T.ORDER_KEY=5202215847;

SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.SALES_SOURCE_SECOND_NAME = '新媒体微信（2.0）'
   AND T.CANCEL_ORDER_AMOUNT <> 0;

SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.SALES_SOURCE_SECOND_NAME = '新媒体微信（2.0）'
   AND T.ITEM_CODE = 217761;

SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.UPDATE_TIME = 20170601
   AND T.SALES_SOURCE_SECOND_KEY = 20021
	 AND T.CANCEL_STATE=1
   AND T.GOODS_COMMON_KEY = 217761;
	 
SELECT *
  FROM FACT_GOODS_SALES_REVERSE T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.SALES_SOURCE_SECOND_KEY = 20021
   AND T.GOODS_COMMON_KEY = 217761;

--221487,-505
SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.UPDATE_TIME = 20170601
   AND T.GOODS_COMMON_KEY = 195923
   AND T.SALES_SOURCE_SECOND_KEY = 20021;

SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.Item_Code = 219237
   AND T.Sales_Source_Name = '电商';
SELECT *
  FROM FACT_GOODS_SALES_REVERSE T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 207951
   AND T.SALES_SOURCE_SECOND_KEY = 20021;
SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.UPDATE_TIME = 20170601
   AND T.GOODS_COMMON_KEY = 221487
   AND T.SALES_SOURCE_SECOND_KEY = 20021;

SELECT T.POSTING_DATE_KEY,
       T.UPDATE_TIME,
       T.GOODS_COMMON_KEY,
       T.CANCEL_STATE,
       T.CANCEL_REASON,
       T.ORDER_AMOUNT
  FROM FACT_GOODS_SALES_REVERSE T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 207951
   AND T.SALES_SOURCE_SECOND_KEY = 20021;

SELECT *
  FROM FACT_GOODS_SALES_REVERSE T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 207951
   AND T.SALES_SOURCE_SECOND_KEY = 20021;

--20170601,219237,+-349
TRUNCATE TABLE OPER_PRODUCT_DAILY_REPORT;
SELECT * FROM OPER_PRODUCT_DAILY_REPORT;

CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170601);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170602);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170603);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170604);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170605);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170606);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170607);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170608);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170609);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170610);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170611);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170612);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170613);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170614);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170615);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170616);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170617);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170618);
CALL YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20170619);


SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT T
 WHERE T.LIVE_OR_REPLAY = '未分配';

SELECT *
  FROM FACT_GOODS_SALES_REVERSE T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 192923
   AND T.Sales_Source_Second_Key = 20017;

SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT'
 ORDER BY T.START_TIME DESC;

SELECT DISTINCT T.POSTING_DATE_KEY
  FROM OPER_PRODUCT_DAILY_REPORT T
 ORDER BY T.POSTING_DATE_KEY;

SELECT /*+PARALLEL(16)*/
DISTINCT T.LIVE_STATE, T.REPLAY_STATE
  FROM FACT_GOODS_SALES T;
SELECT /*+PARALLEL(16)*/
DISTINCT T.LIVE_STATE, T.REPLAY_STATE
  FROM FACT_GOODS_SALES_REVERSE T;
/*
195923
195914
210457我多
*/
SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.ITEM_CODE = 195923
   AND T.SALES_SOURCE_NAME = '电商';
SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 195914
   AND T.Sales_Source_Key = 20;
SELECT *
  FROM FACT_GOODS_SALES_REVERSE T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 195914
   AND T.Sales_Source_Key = 20;

SELECT T.POSTING_DATE_KEY, SUM(T.EFFECTIVE_ORDER_AMOUNT)
  FROM OPER_PRODUCT_DAILY_REPORT T
 GROUP BY T.POSTING_DATE_KEY;
SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.ITEM_CODE = '210457'
   AND T.SALES_SOURCE_SECOND_NAME = '新媒体微信（2.0）';
SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 195923
   AND T.SALES_SOURCE_SECOND_KEY = 20021
   AND T.CANCEL_STATE = 0;
SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.UPDATE_TIME = 20170601
   AND T.GOODS_COMMON_KEY = 195923
   AND T.SALES_SOURCE_SECOND_KEY = 20021;
SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.POSTING_DATE_KEY = 20170601
   AND T.GOODS_COMMON_KEY = 195923
   AND T.SALES_SOURCE_SECOND_KEY = 20021;



SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.CANCEL_STATE = 1
   AND T.POSTING_DATE_KEY > T.UPDATE_TIME;

--6.1过账，6.2下订单
SELECT *
  FROM FACT_GOODS_SALES T
 WHERE T.GOODS_COMMON_KEY = '217619'
   AND T.POSTING_DATE_KEY = 20170601
   AND T.SALES_SOURCE_SECOND_KEY = 20021
   AND T.CANCEL_STATE = 1;
SELECT *
  FROM ODSHAPPIGO.ODS_ORDER T
 WHERE T.ZMATER2 = 217619
   AND T.CRMPOSTDAT = '20170601'
   AND T.ZKUNNR_L2 = 'A20021'
   AND TO_NUMBER(T.ZMATERIAL) = 217619
   AND T.CRM_OBJ_ID IN (5202237124, 5202237128, 5202237175);
SELECT *
  FROM ODSHAPPIGO.ODS_ORDER T
 WHERE T.ZMATER2 = 217619
   AND T.CRMPOSTDAT = '20170602'
   AND T.ZKUNNR_L2 = 'A20021'
   AND TO_NUMBER(T.ZMATERIAL) = 217619;

SELECT *
  FROM ODSHAPPIGO.ODS_ORDER T
 WHERE T.CRM_OBJ_ID IN (5202237124, 5202237128, 5202237175);
SELECT * FROM ODSHAPPIGO.ODS_ORDER_CANCEL T WHERE T;
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME IN ('createordergoods', 'processupdateorder');
