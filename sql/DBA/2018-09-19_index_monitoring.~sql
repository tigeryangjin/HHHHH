--1.2.打开索引监控
SELECT A.OWNER,
       A.TABLE_NAME,
       A.INDEX_NAME,
       'ALTER INDEX ' || A.OWNER || '.' || A.INDEX_NAME ||
       ' MONITORING USAGE;' S
  FROM DBA_INDEXES A
 WHERE A.INDEX_TYPE != 'LOB'
   AND A.OWNER = 'DW_USER'
   AND EXISTS (SELECT 1
          FROM V$OBJECT_USAGE B
         WHERE A.TABLE_NAME = B.TABLE_NAME
           AND A.INDEX_NAME = B.INDEX_NAME
           AND B.monitoring = 'NO'
           AND B.used = 'NO');

--1.2.关闭索引监控
SELECT A.OWNER,
       A.TABLE_NAME,
       A.INDEX_NAME,
       'ALTER INDEX ' || A.OWNER || '.' || A.INDEX_NAME ||
       ' NOMONITORING USAGE;' S
  FROM DBA_INDEXES A
 WHERE A.INDEX_TYPE != 'LOB'
   AND A.OWNER = 'DW_USER'
   AND EXISTS (SELECT 1
          FROM V$OBJECT_USAGE B
         WHERE A.TABLE_NAME = B.TABLE_NAME
           AND A.INDEX_NAME = B.INDEX_NAME
           AND B.MONITORING = 'YES');

--2.索引是否使用
SELECT I.TABLE_OWNER,
       T.TABLE_NAME,
       I.INDEX_NAME,
       U.MONITORING,
       U.USED,
       U.START_MONITORING,
       U.END_MONITORING
  FROM USER_TABLES T
 INNER JOIN USER_INDEXES I
    ON T.TABLE_NAME = I.TABLE_NAME
 INNER JOIN V$OBJECT_USAGE U
    ON U.TABLE_NAME = I.TABLE_NAME
   AND I.INDEX_NAME = U.INDEX_NAME
 WHERE I.TABLE_OWNER IN ('DW_HAPPIGO', 'DW_USER', 'ODSHAPPIGO');

--3.
SELECT A.USED, COUNT(1) FROM V$OBJECT_USAGE A GROUP BY A.USED;

--tmp
ALTER INDEX DISTRICT_LIST_I1 MONITORING USAGE;
ALTER INDEX DISTRICT_LIST_I1 NOMONITORING USAGE;

SELECT *
  FROM V$OBJECT_USAGE A
 WHERE A.table_name = 'DISTRICT_LIST'
   AND A.index_name = 'DISTRICT_LIST_I1';
