--1.创建临时表
CREATE TABLE DW_USER.DATA_ACQUISITION_ITEM_CUR_TMP  PARTITION BY RANGE (PERIOD)
(PARTITION P201612 VALUES LESS THAN (20170101),
 PARTITION P201701 VALUES LESS THAN (20170201),
 PARTITION P201702 VALUES LESS THAN (20170301),
 PARTITION P201703 VALUES LESS THAN (20170401),
 PARTITION P201704 VALUES LESS THAN (20170501),
 PARTITION P201705 VALUES LESS THAN (20170601),
 PARTITION P201706 VALUES LESS THAN (20170701),
 PARTITION P201707 VALUES LESS THAN (20170801),
 PARTITION P201708 VALUES LESS THAN (20170901),
 PARTITION P201709 VALUES LESS THAN (20171001),
 PARTITION P201710 VALUES LESS THAN (20171101),
 PARTITION P201711 VALUES LESS THAN (20171201),
 --
 PARTITION P201712 VALUES LESS THAN (20180101),
 PARTITION P201801 VALUES LESS THAN (20180201),
 PARTITION P201802 VALUES LESS THAN (20180301),
 PARTITION P201803 VALUES LESS THAN (20180401),
 PARTITION P201804 VALUES LESS THAN (20180501),
 PARTITION P201805 VALUES LESS THAN (20180601),
 PARTITION P201806 VALUES LESS THAN (20180701),
 PARTITION P201807 VALUES LESS THAN (20180801),
 PARTITION P201808 VALUES LESS THAN (20180901),
 PARTITION P201809 VALUES LESS THAN (20181001),
 PARTITION P201810 VALUES LESS THAN (20181101),
 PARTITION P201811 VALUES LESS THAN (20181201),
 --
 PARTITION P201812 VALUES LESS THAN (20190101),
 PARTITION P201901 VALUES LESS THAN (20190201),
 PARTITION P201902 VALUES LESS THAN (20190301),
 PARTITION P201903 VALUES LESS THAN (20190401),
 PARTITION P201904 VALUES LESS THAN (20190501),
 PARTITION P201905 VALUES LESS THAN (20190601),
 PARTITION P201906 VALUES LESS THAN (20190701),
 PARTITION P201907 VALUES LESS THAN (20190801),
 PARTITION P201908 VALUES LESS THAN (20190901),
 PARTITION P201909 VALUES LESS THAN (20191001),
 PARTITION P201910 VALUES LESS THAN (20191101),
 PARTITION P201911 VALUES LESS THAN (20191201),
 --  
 PARTITION P201912 VALUES LESS THAN (20200101),
 PARTITION P202001 VALUES LESS THAN (20200201),
 PARTITION P202002 VALUES LESS THAN (20200301),
 PARTITION P202003 VALUES LESS THAN (20200401),
 PARTITION P202004 VALUES LESS THAN (20200501),
 PARTITION P202005 VALUES LESS THAN (20200601),
 PARTITION P202006 VALUES LESS THAN (20200701),
 PARTITION P202007 VALUES LESS THAN (20200801),
 PARTITION P202008 VALUES LESS THAN (20200901),
 PARTITION P202009 VALUES LESS THAN (20201001),
 PARTITION P202010 VALUES LESS THAN (20201101),
 PARTITION P202011 VALUES LESS THAN (20201201),
--
 PARTITION P202012 VALUES LESS THAN (20210101),
 PARTITION P202101 VALUES LESS THAN (20210201),
 PARTITION P202102 VALUES LESS THAN (20210301),
 PARTITION P202103 VALUES LESS THAN (20210401),
 PARTITION P202104 VALUES LESS THAN (20210501),
 PARTITION P202105 VALUES LESS THAN (20210601),
 PARTITION P202106 VALUES LESS THAN (20210701),
 PARTITION P202107 VALUES LESS THAN (20210801),
 PARTITION P202108 VALUES LESS THAN (20210901),
 PARTITION P202109 VALUES LESS THAN (20211001),
 PARTITION P202110 VALUES LESS THAN (20211101),
 PARTITION P202111 VALUES LESS THAN (20211201),
--
 PARTITION P202112 VALUES LESS THAN (20220101),
 PARTITION P202201 VALUES LESS THAN (20220201),
 PARTITION P202202 VALUES LESS THAN (20220301),
 PARTITION P202203 VALUES LESS THAN (20220401),
 PARTITION P202204 VALUES LESS THAN (20220501),
 PARTITION P202205 VALUES LESS THAN (20220601),
 PARTITION P202206 VALUES LESS THAN (20220701),
 PARTITION P202207 VALUES LESS THAN (20220801),
 PARTITION P202208 VALUES LESS THAN (20220901),
 PARTITION P202209 VALUES LESS THAN (20221001),
 PARTITION P202210 VALUES LESS THAN (20221101),
 PARTITION P202211 VALUES LESS THAN (20221201), 
 PARTITION PMAX VALUES LESS THAN (MAXVALUE))
 AS SELECT *
FROM DW_USER.DATA_ACQUISITION_ITEM_CURRENT T WHERE 1=2;


--2.检查表能够被重定义
BEGIN
  DBMS_REDEFINITION.CAN_REDEF_TABLE('DW_USER',
                                    'DATA_ACQUISITION_ITEM_CURRENT',
                                    DBMS_REDEFINITION.CONS_USE_PK);
END;
/


--3.开始重定义
ALTER SESSION FORCE PARALLEL DML PARALLEL 8;
ALTER SESSION FORCE PARALLEL QUERY PARALLEL 8;
BEGIN
  DBMS_REDEFINITION.START_REDEF_TABLE(UNAME        => 'DW_USER',
                                      ORIG_TABLE   => 'DATA_ACQUISITION_ITEM_CURRENT',
                                      INT_TABLE    => 'DATA_ACQUISITION_ITEM_CUR_TMP',
                                      COL_MAPPING  => 'PERIOD PERIOD,
                       MATDLT MATDLT,
                       MATZLT MATZLT,
                       MATXLT MATXLT,
                       ACQ_ITEM_CODE ACQ_ITEM_CODE,
                       ACQ_NAME ACQ_NAME,
                       ACQ_URL ACQ_URL,
                       ACQ_PIC ACQ_PIC,
                       ACQ_SHOP_NAME ACQ_SHOP_NAME,
                       ACQ_PRICE ACQ_PRICE,
                       CURRENT_ACQ_SALES CURRENT_ACQ_SALES,
                       CURRENT_SALES_AMT CURRENT_SALES_AMT',
                                      OPTIONS_FLAG => DBMS_REDEFINITION.CONS_USE_PK);
END;
/

--3.1.终止重定义
BEGIN
  DBMS_REDEFINITION.ABORT_REDEF_TABLE('DW_USER', 'DATA_ACQUISITION_ITEM_CURRENT', 'DATA_ACQUISITION_ITEM_CUR_TMP');
END;
/

--4.将重定义表的依赖对象复制到临时表
DECLARE
  num_errors PLS_INTEGER;
BEGIN
  DBMS_REDEFINITION.COPY_TABLE_DEPENDENTS('DW_USER',
                                          'DATA_ACQUISITION_ITEM_CURRENT',
                                          'DATA_ACQUISITION_ITEM_CUR_TMP',
                                          DBMS_REDEFINITION.CONS_ORIG_PARAMS,
                                          TRUE,
                                          TRUE,
                                          TRUE,
                                          TRUE,
                                          num_errors);
END;
/

--5.检查是否有报错信息
SELECT OBJECT_NAME, BASE_TABLE_NAME, DDL_TXT FROM DBA_REDEFINITION_ERRORS;

--6.结束在线重定义
BEGIN
  DBMS_REDEFINITION.FINISH_REDEF_TABLE('DW_USER',
                                       'DATA_ACQUISITION_ITEM_CURRENT',
                                       'DATA_ACQUISITION_ITEM_CUR_TMP');
END;
/


--7.移动表空间
SELECT 'ALTER TABLE ' || TABLE_NAME || ' MOVE PARTITION ' || PARTITION_NAME ||
       ' TABLESPACE DWDATA00 PARALLEL 4;'
  FROM USER_TAB_PARTITIONS
 WHERE TABLE_NAME = 'DATA_ACQUISITION_ITEM_BASE';
 
--8.统计分析表
BEGIN
  DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => 'DW_USER',
                                TABNAME => 'DATA_ACQUISITION_ITEM_CURRENT',
                                DEGREE  => 16,
                                --PARTNAME         => 'p_201312',
                                --ESTIMATE_PERCENT => 10,
                                --METHOD_OPT       => 'for all indexed columns',
                                CASCADE => TRUE);
END;
/

--9.




SELECT * FROM DATA_ACQUISITION_ITEM_BASE A;
SELECT * FROM DATA_ACQUISITION_ITEM_BASE_TMP;


