--1.创建临时表
CREATE TABLE DW_USER.FACT_GOODS_SALES_TMP  PARTITION BY RANGE (POSTING_DATE_KEY)
(PARTITION P200512 VALUES LESS THAN (20060101),
 PARTITION P200601 VALUES LESS THAN (20060201),
 PARTITION P200602 VALUES LESS THAN (20060301),
 PARTITION P200603 VALUES LESS THAN (20060401),
 PARTITION P200604 VALUES LESS THAN (20060501),
 PARTITION P200605 VALUES LESS THAN (20060601),
 PARTITION P200606 VALUES LESS THAN (20060701),
 PARTITION P200607 VALUES LESS THAN (20060801),
 PARTITION P200608 VALUES LESS THAN (20060901),
 PARTITION P200609 VALUES LESS THAN (20061001),
 PARTITION P200610 VALUES LESS THAN (20061101),
 PARTITION P200611 VALUES LESS THAN (20061201),
 PARTITION P200612 VALUES LESS THAN (20070101),
 --2007
 PARTITION P200701 VALUES LESS THAN (20070201),
 PARTITION P200702 VALUES LESS THAN (20070301),
 PARTITION P200703 VALUES LESS THAN (20070401),
 PARTITION P200704 VALUES LESS THAN (20070501),
 PARTITION P200705 VALUES LESS THAN (20070601),
 PARTITION P200706 VALUES LESS THAN (20070701),
 PARTITION P200707 VALUES LESS THAN (20070801),
 PARTITION P200708 VALUES LESS THAN (20070901),
 PARTITION P200709 VALUES LESS THAN (20071001),
 PARTITION P200710 VALUES LESS THAN (20071101),
 PARTITION P200711 VALUES LESS THAN (20071201),
 PARTITION P200712 VALUES LESS THAN (20080101),
 --2008
 PARTITION P200801 VALUES LESS THAN (20080201),
 PARTITION P200802 VALUES LESS THAN (20080301),
 PARTITION P200803 VALUES LESS THAN (20080401),
 PARTITION P200804 VALUES LESS THAN (20080501),
 PARTITION P200805 VALUES LESS THAN (20080601),
 PARTITION P200806 VALUES LESS THAN (20080701),
 PARTITION P200807 VALUES LESS THAN (20080801),
 PARTITION P200808 VALUES LESS THAN (20080901),
 PARTITION P200809 VALUES LESS THAN (20081001),
 PARTITION P200810 VALUES LESS THAN (20081101),
 PARTITION P200811 VALUES LESS THAN (20081201),
 PARTITION P200812 VALUES LESS THAN (20090101),
 --2009
 PARTITION P200901 VALUES LESS THAN (20090201),
 PARTITION P200902 VALUES LESS THAN (20090301),
 PARTITION P200903 VALUES LESS THAN (20090401),
 PARTITION P200904 VALUES LESS THAN (20090501),
 PARTITION P200905 VALUES LESS THAN (20090601),
 PARTITION P200906 VALUES LESS THAN (20090701),
 PARTITION P200907 VALUES LESS THAN (20090801),
 PARTITION P200908 VALUES LESS THAN (20090901),
 PARTITION P200909 VALUES LESS THAN (20091001),
 PARTITION P200910 VALUES LESS THAN (20091101),
 PARTITION P200911 VALUES LESS THAN (20091201),
 PARTITION P200912 VALUES LESS THAN (20100101),
 --2010
 PARTITION P201001 VALUES LESS THAN (20100201),
 PARTITION P201002 VALUES LESS THAN (20100301),
 PARTITION P201003 VALUES LESS THAN (20100401),
 PARTITION P201004 VALUES LESS THAN (20100501),
 PARTITION P201005 VALUES LESS THAN (20100601),
 PARTITION P201006 VALUES LESS THAN (20100701),
 PARTITION P201007 VALUES LESS THAN (20100801),
 PARTITION P201008 VALUES LESS THAN (20100901),
 PARTITION P201009 VALUES LESS THAN (20101001),
 PARTITION P201010 VALUES LESS THAN (20101101),
 PARTITION P201011 VALUES LESS THAN (20101201),
 PARTITION P201012 VALUES LESS THAN (20110101),
 --2011
 PARTITION P201101 VALUES LESS THAN (20110201),
 PARTITION P201102 VALUES LESS THAN (20110301),
 PARTITION P201103 VALUES LESS THAN (20110401),
 PARTITION P201104 VALUES LESS THAN (20110501),
 PARTITION P201105 VALUES LESS THAN (20110601),
 PARTITION P201106 VALUES LESS THAN (20110701),
 PARTITION P201107 VALUES LESS THAN (20110801),
 PARTITION P201108 VALUES LESS THAN (20110901),
 PARTITION P201109 VALUES LESS THAN (20111001),
 PARTITION P201110 VALUES LESS THAN (20111101),
 PARTITION P201111 VALUES LESS THAN (20111201),
 PARTITION P201112 VALUES LESS THAN (20120101),
 --2012
 PARTITION P201201 VALUES LESS THAN (20120201),
 PARTITION P201202 VALUES LESS THAN (20120301),
 PARTITION P201203 VALUES LESS THAN (20120401),
 PARTITION P201204 VALUES LESS THAN (20120501),
 PARTITION P201205 VALUES LESS THAN (20120601),
 PARTITION P201206 VALUES LESS THAN (20120701),
 PARTITION P201207 VALUES LESS THAN (20120801),
 PARTITION P201208 VALUES LESS THAN (20120901),
 PARTITION P201209 VALUES LESS THAN (20121001),
 PARTITION P201210 VALUES LESS THAN (20121101),
 PARTITION P201211 VALUES LESS THAN (20121201),
 PARTITION P201212 VALUES LESS THAN (20130101),
 --2013
 PARTITION P201301 VALUES LESS THAN (20130201),
 PARTITION P201302 VALUES LESS THAN (20130301),
 PARTITION P201303 VALUES LESS THAN (20130401),
 PARTITION P201304 VALUES LESS THAN (20130501),
 PARTITION P201305 VALUES LESS THAN (20130601),
 PARTITION P201306 VALUES LESS THAN (20130701),
 PARTITION P201307 VALUES LESS THAN (20130801),
 PARTITION P201308 VALUES LESS THAN (20130901),
 PARTITION P201309 VALUES LESS THAN (20131001),
 PARTITION P201310 VALUES LESS THAN (20131101),
 PARTITION P201311 VALUES LESS THAN (20131201),
 PARTITION P201312 VALUES LESS THAN (20140101),
 --2014
 PARTITION P201401 VALUES LESS THAN (20140201),
 PARTITION P201402 VALUES LESS THAN (20140301),
 PARTITION P201403 VALUES LESS THAN (20140401),
 PARTITION P201404 VALUES LESS THAN (20140501),
 PARTITION P201405 VALUES LESS THAN (20140601),
 PARTITION P201406 VALUES LESS THAN (20140701),
 PARTITION P201407 VALUES LESS THAN (20140801),
 PARTITION P201408 VALUES LESS THAN (20140901),
 PARTITION P201409 VALUES LESS THAN (20141001),
 PARTITION P201410 VALUES LESS THAN (20141101),
 PARTITION P201411 VALUES LESS THAN (20141201),
 PARTITION P201412 VALUES LESS THAN (20150101),
 --2015
 PARTITION P201501 VALUES LESS THAN (20150201),
 PARTITION P201502 VALUES LESS THAN (20150301),
 PARTITION P201503 VALUES LESS THAN (20150401),
 PARTITION P201504 VALUES LESS THAN (20150501),
 PARTITION P201505 VALUES LESS THAN (20150601),
 PARTITION P201506 VALUES LESS THAN (20150701),
 PARTITION P201507 VALUES LESS THAN (20150801),
 PARTITION P201508 VALUES LESS THAN (20150901),
 PARTITION P201509 VALUES LESS THAN (20151001),
 PARTITION P201510 VALUES LESS THAN (20151101),
 PARTITION P201511 VALUES LESS THAN (20151201),
 PARTITION P201512 VALUES LESS THAN (20160101),
 --2016
 PARTITION P201601 VALUES LESS THAN (20160201),
 PARTITION P201602 VALUES LESS THAN (20160301),
 PARTITION P201603 VALUES LESS THAN (20160401),
 PARTITION P201604 VALUES LESS THAN (20160501),
 PARTITION P201605 VALUES LESS THAN (20160601),
 PARTITION P201606 VALUES LESS THAN (20160701),
 PARTITION P201607 VALUES LESS THAN (20160801),
 PARTITION P201608 VALUES LESS THAN (20160901),
 PARTITION P201609 VALUES LESS THAN (20161001),
 PARTITION P201610 VALUES LESS THAN (20161101),
 PARTITION P201611 VALUES LESS THAN (20161201),
 PARTITION P201612 VALUES LESS THAN (20170101),
 --2017
 PARTITION P201701 VALUES LESS THAN (20170201),
 PARTITION P201702 VALUES LESS THAN (20170301),
 PARTITION P201703 VALUES LESS THAN (20170401),
 PARTITION P201704 VALUES LESS THAN (20170501),
 PARTITION P201705 VALUES LESS THAN (20170601),
 PARTITION P201706 VALUES LESS THAN (20170701),
 PARTITION P201707 VALUES LESS THAN (20170801),
 PARTITION P201708 VALUES LESS THAN (20170901),
 PARTITION P201709 VALUES LESS THAN (20171001),
 PARTITION P201710 VALUES LESS THAN (20171101),
 PARTITION P201711 VALUES LESS THAN (20171201),
 PARTITION P201712 VALUES LESS THAN (20180101),
 --2018
 PARTITION P201801 VALUES LESS THAN (20180201),
 PARTITION P201802 VALUES LESS THAN (20180301),
 PARTITION P201803 VALUES LESS THAN (20180401),
 PARTITION P201804 VALUES LESS THAN (20180501),
 PARTITION P201805 VALUES LESS THAN (20180601),
 PARTITION P201806 VALUES LESS THAN (20180701),
 PARTITION P201807 VALUES LESS THAN (20180801),
 PARTITION P201808 VALUES LESS THAN (20180901),
 PARTITION P201809 VALUES LESS THAN (20181001),
 PARTITION P201810 VALUES LESS THAN (20181101),
 PARTITION P201811 VALUES LESS THAN (20181201),
 PARTITION P201812 VALUES LESS THAN (20190101),
 --2019
 PARTITION P201901 VALUES LESS THAN (20190201),
 PARTITION P201902 VALUES LESS THAN (20190301),
 PARTITION P201903 VALUES LESS THAN (20190401),
 PARTITION P201904 VALUES LESS THAN (20190501),
 PARTITION P201905 VALUES LESS THAN (20190601),
 PARTITION P201906 VALUES LESS THAN (20190701),
 PARTITION P201907 VALUES LESS THAN (20190801),
 PARTITION P201908 VALUES LESS THAN (20190901),
 PARTITION P201909 VALUES LESS THAN (20191001),
 PARTITION P201910 VALUES LESS THAN (20191101),
 PARTITION P201911 VALUES LESS THAN (20191201),
 PARTITION P201912 VALUES LESS THAN (20200101),
 PARTITION PMAX VALUES LESS THAN (MAXVALUE))
 AS SELECT *
FROM DW_USER.FACT_GOODS_SALES T WHERE 1=2;


--2.检查表能够被重定义
BEGIN
  DBMS_REDEFINITION.CAN_REDEF_TABLE('DW_USER',
                                    'FACT_GOODS_SALES',
                                    DBMS_REDEFINITION.CONS_USE_PK);
END;
/


--3.开始重定义
ALTER SESSION FORCE PARALLEL DML PARALLEL 8;
ALTER SESSION FORCE PARALLEL QUERY PARALLEL 8;
BEGIN
  DBMS_REDEFINITION.START_REDEF_TABLE(UNAME        => 'DW_USER',
                                      ORIG_TABLE   => 'FACT_GOODS_SALES',
                                      INT_TABLE    => 'FACT_GOODS_SALES_TMP',
                                      COL_MAPPING  => 'SALES_GOODS_ID,
       ORDER_KEY,
       ORDER_H_KEY,
       EC_ORDER_ID,
       EC_ORDER_STATE,
       GLOBEL_ORDER_STATE,
       ADDRESS_KEY,
       MEMBER_KEY,
       MEMBER_GRADE_DESC,
       MEMBER_GRADE_KEY,
       GOODS_KEY,
       GOODS_COMMON_KEY,
       TRAN_TYPE,
       MATERIEL_BIG_KEY,
       MATERIEL_MIDDLE_KEY,
       MATERIEL_SMALL_KEY,
       CATEGORY_KEY,
       EC_CATEGORY_KEY,
       BRAND_KEY,
       LIVE_STATE,
       REPLAY_STATE,
       WINDOW_ID,
       EC_GOODS_STATE,
       TV_GOODS_STATE,
       GROUP_STATE,
       PURCHASING_KEY,
       PURCHASING,
       MD_PERSON,
       SUPPLIER_KEY,
       SUPPLIER_TITLE,
       UNIT_PRICE,
       DISCOUNT_PRICE,
       BARGAIN_PRICE,
       NUMS,
       COST_PRICE,
       PURCHASE_PRICE,
       COUPONS_KEY,
       COUPONS,
       COUPONS_PRICE,
       POINTS_REWARD,
       ORDER_AMOUNT,
       PAY_AMOUNT,
       AMOUNT_PAID,
       PURCHASE_AMOUNT,
       PROFIT_AMOUNT,
       SALES_SOURCE_KEY,
       SALES_SOURCE_DESC,
       SALES_SOURCE_SECOND_KEY,
       SALES_SOURCE_SECOND_DESC,
       ORDER_DATE_KEY,
       ORDER_DATE,
       ORDER_HOUR_KEY,
       ORDER_HOUR,
       POSTING_DATE,
       POSTING_DATE_KEY,
       POSTING_HOUR_KEY,
       POSTING_HOUR,
       ORDER_STATE,
       CANCEL_STATE,
       CANCEL_DATE_KEY,
       CANCEL_DATE,
       CANCEL_HOUR_KEY,
       CANCEL_HOUR,
       CANCEL_PERSON,
       PAY_STATE,
       PAY_DATE_KEY,
       PAY_DATE,
       PAY_HOUR_KEY,
       PAY_HOUR,
       EXCHANGE_GOODS_STATE,
       EXCHANGE_GOODS_DATE_KEY,
       EXCHANGE_GOODS_DATE,
       EXCHANGE_GOODS_HOUR_KEY,
       EXCHANGE_GOODS_HOUR,
       TRAN_DESC,
       ORDER_NET_AMOUNT,
       TAX_AMOUNT,
       SALES_AMOUNT,
       DEVICE_KEY,
       EXCHANGE_GOODS_NUMS,
       EXCHANGE_DATE_FIRST_KEY,
       EXCHANGE_DATE_FIRST,
       EXCHANGE_DATE_LAST_KEY,
       EXCHANGE_DATE_LAST,
       CANCEL_NUMS,
       CANCEL_DATE_FIRST_KEY,
       CANCEL_DATE_FIRST,
       CANCEL_DATE_LAST_KEY,
       CANCEL_DATE_LAST,
       POINTS_TOTAL,
       AMOUNT_ADVANCED,
       CARD_AMOUNT,
       POINTS_NO_AMOUNT,
       FREIGHT_AMOUNT,
       POINTS_AMOUNT,
       EXCHANGE_GOODS_TOTAL,
       CANCEL_TOTAL,
       CANCEL_BEFORE_STATE,
       PRE_ORDER_STATE,
       ORDER_DESC,
       UPDATE_STATE,
       UPDATE_TIME,
       ORDER_FROM',
                                      OPTIONS_FLAG => DBMS_REDEFINITION.CONS_USE_PK);
END;
/

--3.1.终止重定义
BEGIN
  DBMS_REDEFINITION.ABORT_REDEF_TABLE('DW_USER', 'FACT_GOODS_SALES', 'FACT_GOODS_SALES_TMP');
END;
/

--4.将重定义表的依赖对象复制到临时表
DECLARE
  NUM_ERRORS PLS_INTEGER;
BEGIN
  DBMS_REDEFINITION.COPY_TABLE_DEPENDENTS('DW_USER',
                                          'FACT_GOODS_SALES',
                                          'FACT_GOODS_SALES_TMP',
                                          DBMS_REDEFINITION.CONS_ORIG_PARAMS,
                                          TRUE,
                                          TRUE,
                                          TRUE,
                                          TRUE,
                                          NUM_ERRORS);
END;
/

--5.检查是否有报错信息
SELECT OBJECT_NAME, BASE_TABLE_NAME, DDL_TXT FROM DBA_REDEFINITION_ERRORS;

--6.结束在线重定义
BEGIN
  DBMS_REDEFINITION.FINISH_REDEF_TABLE('DW_USER',
                                       'FACT_GOODS_SALES',
                                       'FACT_GOODS_SALES_TMP');
END;
/


--7.
SELECT 'ALTER TABLE ' || TABLE_NAME || ' MOVE PARTITION ' || PARTITION_NAME ||
       ' TABLESPACE DWDATA00 PARALLEL 4;'
  FROM USER_TAB_PARTITIONS
 WHERE TABLE_NAME = 'FACT_GOODS_SALES';
 
--8.
BEGIN
  DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => 'DW_USER',
                                TABNAME => 'FACT_GOODS_SALES',
                                DEGREE  => 16,
                                CASCADE => TRUE);
END;
/

--9.
SELECT * FROM FACT_GOODS_SALES_TMP A;
SELECT * FROM FACT_GOODS_SALES;


