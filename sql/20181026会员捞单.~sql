/*
7、8月浏览过马未都、红木两种商品未购买的用户
*/
TRUNCATE TABLE YANGJIN.ITEM_CODE_TMP;
INSERT INTO YANGJIN.ITEM_CODE_TMP
  (GOODS_COMMONID, ITEM_CODE)
  SELECT A.GOODS_COMMONID, A.ITEM_CODE
    FROM DIM_EC_GOOD A
   WHERE A.GOODS_NAME LIKE '%马未都%'
      OR A.GOODS_NAME LIKE '%刺猬紫檀%';
COMMIT;

SELECT *
  FROM (
        --浏览
        SELECT TO_NUMBER(A.MEMBER_KEY) MEMBER_BP,
                TO_NUMBER(A.PAGE_VALUE) GOODS_COMMONID
          FROM YANGJIN.FACT_PAGE_VIEW_2018_1_9 A
         WHERE A.VISIT_DATE_KEY BETWEEN 20180701 AND 20180831
           AND A.MEMBER_KEY <> 0
           AND a.page_value =
               translate(a.page_value,
                         '0' || translate(a.page_value, '#0123456789', '#'),
                         '0')
           AND EXISTS
         (SELECT 1
                  FROM (SELECT D.GOODS_COMMONID FROM YANGJIN.ITEM_CODE_TMP D) B
                 WHERE A.PAGE_VALUE = B.GOODS_COMMONID)) Z1
 WHERE NOT EXISTS
 (SELECT 1
          FROM ( --订购
                SELECT TO_NUMBER(A.CUST_NO) MEMBER_BP, B.GOODS_COMMONID
                  FROM FACT_EC_ORDER_2 A, FACT_EC_ORDER_GOODS B
                 WHERE A.ORDER_ID = B.ORDER_ID
                   AND A.ADD_TIME BETWEEN DATE '2018-07-01' AND DATE
                 '2018-08-31'
                   AND A.ORDER_STATE >= 20
                   AND A.CUST_NO <> 0
                   AND EXISTS
                 (SELECT 1
                          FROM YANGJIN.ITEM_CODE_TMP C
                         WHERE B.GOODS_COMMONID = C.GOODS_COMMONID)) Z2
         WHERE Z1.MEMBER_BP = Z2.MEMBER_BP
           AND Z1.GOODS_COMMONID = Z2.GOODS_COMMONID);

--订购
SELECT TO_NUMBER(A.CUST_NO) MEMBER_BP, B.GOODS_COMMONID
  FROM FACT_EC_ORDER_2 A, FACT_EC_ORDER_GOODS B
 WHERE A.ORDER_ID = B.ORDER_ID
   AND A.ADD_TIME BETWEEN DATE '2018-07-01' AND DATE '2018-08-31'
   AND A.ORDER_STATE >= 20
   AND A.CUST_NO <> 0
   AND EXISTS (SELECT 1
          FROM YANGJIN.ITEM_CODE_TMP C
         WHERE B.GOODS_COMMONID = C.GOODS_COMMONID);

/*
9月1日-10月25日浏览过服装的用户，按照浏览次数排
*/

--浏览
SELECT TO_NUMBER(A.MEMBER_KEY) MEMBER_BP,
       COUNT(DISTINCT A.PAGE_VALUE) ITEM_CNT
  FROM YANGJIN.FACT_PAGE_VIEW_2018_1_9 A
 WHERE A.MEMBER_KEY <> 0
   AND a.page_value =
       translate(a.page_value,
                 '0' || translate(a.page_value, '#0123456789', '#'),
                 '0')
   AND EXISTS (SELECT 1
          FROM (SELECT D.GOODS_COMMONID
                  FROM DIM_EC_GOOD D, DIM_GOOD_CLASS E
                 WHERE D.MATKL = E.MATKL
                   AND E.MATDL = 58) B
         WHERE A.PAGE_VALUE = B.GOODS_COMMONID)
 GROUP BY TO_NUMBER(A.MEMBER_KEY)
 ORDER BY COUNT(DISTINCT A.PAGE_VALUE) DESC;

--TMP
SELECT * FROM DIM_EC_GOOD A WHERE A.GOODS_NAME LIKE '%马未都%';
SELECT * FROM DIM_EC_GOOD A WHERE A.GOODS_NAME LIKE '%刺猬紫檀%';
SELECT * FROM DIM_GOOD_CLASS A WHERE A.MATDLT LIKE '%服装%';
SELECT * FROM DIM_GOOD_CLASS A WHERE A.MATZLT LIKE '%服装%';
SELECT * FROM DIM_GOOD_CLASS A WHERE A.MATXLT LIKE '%服装%';
SELECT * FROM DIM_GOOD_CLASS A WHERE A.Matklt LIKE '%服装%';

SELECT * FROM ALL_SOURCE A WHERE UPPER(A.TEXT) LIKE '%ITEM_CODE_TMP%';
