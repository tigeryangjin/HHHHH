--*********************************************************************
--1.daily check
--*********************************************************************
--1.1.W_ETL_LOG check
SELECT *
  FROM W_ETL_LOG T
 WHERE TRUNC(T.START_TIME) >= TRUNC(SYSDATE) - 1
   AND (T.ETL_STATUS <> 'SUCCESS' OR T.ETL_STATUS IS NULL)
 ORDER BY T.START_TIME DESC;

SELECT *
  FROM W_ETL_LOG@BITONEWBI T
 WHERE TRUNC(T.START_TIME) >= TRUNC(SYSDATE) - 1
   AND (T.ETL_STATUS <> 'SUCCESS' OR T.ETL_STATUS IS NULL)
 ORDER BY T.START_TIME DESC;

--1.2.29line
/*
HAPPIGO_EC_PKG_1  HAPPIGO_EC_PKG.MERGE_EC_ORDER
HAPPIGO_EC_PKG_2  HAPPIGO_EC_PKG.MERGE_EC_ORDER_COMMON
HAPPIGO_EC_PKG_3  HAPPIGO_EC_PKG.MERGE_EC_ORDER_GOODS
HAPPIGO_EC_PKG_4  HAPPIGO_EC_PKG.MERGE_EC_P_MANSONG
HAPPIGO_EC_PKG_5  HAPPIGO_EC_PKG.MERGE_EC_P_MANSONG_GOODS
HAPPIGO_EC_PKG_6  HAPPIGO_EC_PKG.MERGE_EC_P_XIANSHI
HAPPIGO_EC_PKG_7  HAPPIGO_EC_PKG.MERGE_EC_P_XIANSHI_GOODS
HAPPIGO_EC_PKG_8  HAPPIGO_EC_PKG.MERGE_EC_VOUCHER
HAPPIGO_EC_PKG_9  HAPPIGO_EC_PKG.MERGE_EC_VOUCHER_BATCH
HAPPIGO_EC_PKG_10 HAPPIGO_EC_PKG.MERGE_EC_VOUCHER_PRICE
MEMBER_LABEL_PKG_1  MEMBER_LABEL_PKG.COMMON_PORT
MEMBER_LABEL_PKG_2  MEMBER_LABEL_PKG.FIRST_ORDER_GIFT
MEMBER_LABEL_PKG_3  MEMBER_LABEL_PKG.FIRST_ORDER_ITEM
MEMBER_LABEL_PKG_4  MEMBER_LABEL_PKG.FIRST_ORDER_NOT
MEMBER_LABEL_PKG_5  MEMBER_LABEL_PKG.MEMBER_INJURED_PERIOD
MEMBER_LABEL_PKG_6  MEMBER_LABEL_PKG.MEMBER_LEVEL
MEMBER_LABEL_PKG_7  MEMBER_LABEL_PKG.MEMBER_LIFE_PERIOD
MEMBER_LABEL_PKG_8  MEMBER_LABEL_PKG.MEMBER_PAYMENT_METHOD
MEMBER_LABEL_PKG_9  MEMBER_LABEL_PKG.MEMBER_REPURCHASE
MEMBER_SMS_PKG_1  MEMBER_SMS_PKG.MEMBER_SMS_POOL_OMMD
MEMBER_SMS_PKG_2  MEMBER_SMS_PKG.OPER_MEMBER_MBLEVEL_DCGOOD
YANGJIN_PKG_1 YANGJIN_PKG.DIM_GOOD_PRICE_LEVEL_UPDATE
YANGJIN_PKG_2 YANGJIN_PKG.OPER_MEMBER_NOT_IN_EC
YANGJIN_PKG_3 YANGJIN_PKG.OPER_NM_PROMOTION_ITEM_RPT
YANGJIN_PKG_4 YANGJIN_PKG.OPER_NM_PROMOTION_ORDER_RPT
YANGJIN_PKG_5 YANGJIN_PKG.OPER_NM_VOUCHER_RPT
YANGJIN_PKG_6 YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT
YANGJIN_PKG_7 YANGJIN_PKG.OPER_PRODUCT_PVUV_DAILY_RPT
YANGJIN_PKG_8 YANGJIN_PKG.PROCESSMAKETHMSC_IA
*/
SELECT T.START_TIME,
       T.END_TIME,
       T.ETL_DURATION,
       T.ETL_RECORD_INS,
       T.ETL_RECORD_UPD,
       T.ETL_STATUS,
       SUBSTR(T.PROC_NAME, 1, INSTR(T.PROC_NAME, '.') - 1) || '_' || RANK() OVER(PARTITION BY SUBSTR(T.PROC_NAME, 1, INSTR(T.PROC_NAME, '.') - 1) ORDER BY T.PROC_NAME, T.END_TIME DESC) RANK1,
       T.PROC_NAME,
       T.TABLE_NAME,
       T.ERR_MSG
  FROM W_ETL_LOG T
 WHERE (T.PROC_NAME LIKE 'YANGJIN_PKG%' OR T.PROC_NAME LIKE 'MEMBER%' OR
       T.PROC_NAME LIKE 'HAPPIGO_EC_PKG%')
   AND TRUNC(T.START_TIME) = TRUNC(SYSDATE) ;

--1.3.8line
/*
OPER_MEMBER_LIKE_PKG_1	OPER_MEMBER_LIKE_PKG.OPER_MEMBER_LIKE_BASE_PROC
OPER_MEMBER_LIKE_PKG_2	OPER_MEMBER_LIKE_PKG.OPER_MEMBER_LIKE_ITEM_PROC
OPER_MEMBER_LIKE_PKG_3	OPER_MEMBER_LIKE_PKG.OPER_MEMBER_LIKE_MATXL_PROC
OPER_MEMBER_MARKETING_PKG_1	OPER_MEMBER_MARKETING_PKG.PROC_MBR_FIRST_ORDER_15DAYS
OPER_MEMBER_MARKETING_PKG_2	OPER_MEMBER_MARKETING_PKG.PROC_MBR_ORDER_PUSH
OPER_MEMBER_MARKETING_PKG_3	OPER_MEMBER_MARKETING_PKG.PROC_MBR_REG_WITHOUT_ORDER
OPER_MEMBER_MARKETING_PKG_4	OPER_MEMBER_MARKETING_PKG.PROC_MBR_SECOND_ORDER_20DAYS
OPER_MEMBER_MARKETING_PKG_5	OPER_MEMBER_MARKETING_PKG.PROC_MBR_THIRD_ORDER_30DAYS
*/
SELECT T.START_TIME,
       T.END_TIME,
       T.ETL_DURATION,
       T.ETL_RECORD_INS,
       T.ETL_RECORD_UPD,
       T.ETL_STATUS,
       SUBSTR(T.PROC_NAME, 1, INSTR(T.PROC_NAME, '.') - 1) || '_' || RANK() OVER(PARTITION BY SUBSTR(T.PROC_NAME, 1, INSTR(T.PROC_NAME, '.') - 1) ORDER BY T.PROC_NAME, T.END_TIME DESC) RANK1,
       T.PROC_NAME,
       T.TABLE_NAME,
       T.ERR_MSG
  FROM W_ETL_LOG@BITONEWBI T
 WHERE T.PROC_NAME LIKE 'OPER_MEMBER%'
   AND TRUNC(T.START_TIME) = TRUNC(SYSDATE);

--*************************************************************************************
--2.异常检查
--*************************************************************************************
--2.1.会员发券监控(PROCESSED:1 成功 2失败 3接口错误 9 不用发券)
SELECT A.PROCESSED, COUNT(A.MEMBER_KEY)
  FROM OPER_MBR_REG_WITHOUT_ORDER@BITONEWBI A
 WHERE A.RECORD_DATE_KEY = TO_CHAR(TRUNC(SYSDATE - 2), 'YYYYMMDD')
 GROUP BY A.PROCESSED;
SELECT A.PROCESSED, COUNT(A.MEMBER_KEY)
  FROM OPER_MBR_ORDER_RETAIN_PUSH@BITONEWBI A
 WHERE A.RECORD_DATE_KEY = TO_CHAR(TRUNC(SYSDATE - 2), 'YYYYMMDD')
 GROUP BY A.PROCESSED;
SELECT A.PROCESSED, COUNT(A.MEMBER_KEY)
  FROM OPER_MBR_REG_WITHOUT_ORDER@BITONEWBI A
 WHERE A.RECORD_DATE_KEY = TO_CHAR(TRUNC(SYSDATE - 1), 'YYYYMMDD')
 GROUP BY A.PROCESSED;
SELECT A.PROCESSED, COUNT(A.MEMBER_KEY)
  FROM OPER_MBR_ORDER_RETAIN_PUSH@BITONEWBI A
 WHERE A.RECORD_DATE_KEY = TO_CHAR(TRUNC(SYSDATE - 1), 'YYYYMMDD')
 GROUP BY A.PROCESSED;
SELECT A.PROCESSED, COUNT(A.MEMBER_KEY)
  FROM OPER_MBR_THIRD_ORDER_CAL_MONTH@BITONEWBI A
 WHERE A.MONTH_KEY = TO_CHAR(TRUNC(SYSDATE - 1, 'MONTH') - 1, 'YYYYMM')
 GROUP BY A.PROCESSED;
SELECT A.PROCESSED, COUNT(A.MEMBER_KEY)
  FROM OPER_MBR_TWELVE_ORDER_YEAR@BITONEWBI A
 WHERE A.MONTH_KEY = TO_CHAR(TRUNC(SYSDATE - 1, 'MONTH') - 1, 'YYYYMM')
 GROUP BY A.PROCESSED;

--2.2.订购退货单据是否传入DW
SELECT *
  FROM FACT_GOODS_SALES A
 WHERE A.POSTING_DATE_KEY = TO_CHAR(TRUNC(SYSDATE) - 1, 'YYYYMMDD');
SELECT *
  FROM FACT_GOODS_SALES_REVERSE A
 WHERE A.POSTING_DATE_KEY = TO_CHAR(TRUNC(SYSDATE) - 1, 'YYYYMMDD');
SELECT *
  FROM FACT_ORDER A
 WHERE A.POSTING_DATE_KEY = TO_CHAR(TRUNC(SYSDATE) - 1, 'YYYYMMDD');
SELECT /*+PARALLEL(16)*/
 *
  FROM ODSHAPPIGO.ODS_ORDER A
 WHERE A.CRMPOSTDAT = 20170902;

--2.3.商品资料缺失
SELECT DISTINCT A.GOODS_KEY
  FROM OPER_PRODUCT_DAILY_REPORT A
 WHERE A.POSTING_DATE_KEY = TO_CHAR(SYSDATE - 1, 'YYYYMMDD')
   AND A.GOODS_NAME IS NULL
 ORDER BY 1;
--2.3.1.每个商品的最大ROW_WID的current_flg='Y'
SELECT *
  FROM DIM_GOOD A
 WHERE EXISTS (SELECT 1
          FROM (SELECT B.ITEM_CODE, MAX(B.ROW_WID) ROW_WID
                  FROM DIM_GOOD B
                 GROUP BY B.ITEM_CODE) C
         WHERE A.ITEM_CODE = C.ITEM_CODE
           AND A.ROW_WID = C.ROW_WID)
   AND A.CURRENT_FLG = 'N';

SELECT *
  from dim_good a
 where a.item_code in
       (SELECT DISTINCT A.GOODS_KEY
          FROM OPER_PRODUCT_DAILY_REPORT A
         WHERE A.POSTING_DATE_KEY = TO_CHAR(SYSDATE - 1, 'YYYYMMDD')
           AND A.GOODS_NAME IS NULL);
SELECT *
  from ods_zmaterial a
 where a.zmater2 in
       (SELECT DISTINCT '000000000000' || A.GOODS_KEY
          FROM OPER_PRODUCT_DAILY_REPORT A
         WHERE A.POSTING_DATE_KEY = TO_CHAR(SYSDATE - 1, 'YYYYMMDD')
           AND A.GOODS_NAME IS NULL)
--and a.zmaterial not like '%F%'
--and a.ZEAMC027 is not null
/*and a.zeamc027 != 0*/
;

SELECT A.GOODS_COMMON_KEY, MIN(A.POSTING_DATE_KEY)
  FROM FACT_GOODS_SALES A
 WHERE A.GOODS_COMMON_KEY IN
       (SELECT DISTINCT A.GOODS_KEY
          FROM OPER_PRODUCT_DAILY_REPORT A
         WHERE A.POSTING_DATE_KEY = TO_CHAR(SYSDATE - 1, 'YYYYMMDD')
           AND A.GOODS_NAME IS NULL)
 GROUP BY A.GOODS_COMMON_KEY
 ORDER BY 1;

SELECT *
  FROM DIM_EC_GOOD A
 WHERE A.ITEM_CODE IN (224294, 224086, 224793, 224605, 224174, 224794);

SELECT *
  FROM W_ETL_LOG A
 WHERE A.PROC_NAME = 'YANGJIN_PKG.DIM_GOOD_FIX'
 ORDER BY A.START_TIME DESC;

CALL YANGJIN_PKG.DIM_GOOD_FIX();

--**************************************************************************
--3.查询单个任务执行日志
--**************************************************************************
--3.1.YANGJIN_PKG.PROCESSMAKETHMSC_IA
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'YANGJIN_PKG.PROCESSMAKETHMSC_IA'
 ORDER BY T.START_TIME DESC;

--3.2.YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT'
 ORDER BY T.START_TIME DESC;

--3.3.YANGJIN_PKG.OPER_PRODUCT_PVUV_DAILY_RPT
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'YANGJIN_PKG.OPER_PRODUCT_PVUV_DAILY_RPT'
 ORDER BY T.START_TIME DESC;

--3.4.YANGJIN_PKG.OPER_PRODUCT_PVUV_DAILY_RPT
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'YANGJIN_PKG.OPER_MEMBER_MBLEVEL_DCGOOD'
 ORDER BY T.START_TIME DESC;

--3.4.YANGJIN_PKG.DIM_GOOD_FIX
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'YANGJIN_PKG.DIM_GOOD_FIX'
 ORDER BY T.START_TIME DESC;

--3.5.processgood
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'processgood'
 ORDER BY T.START_TIME DESC;

--3.6.MEMBER_LABEL_PKG.MEMBER_REPURCHASE
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'MEMBER_LABEL_PKG.MEMBER_REPURCHASE'
 ORDER BY T.START_TIME DESC;
 
--3.7.MEMBER_LABEL_PKG.MEMBER_LIFE_PERIOD
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME = 'MEMBER_LABEL_PKG.MEMBER_LIFE_PERIOD'
 ORDER BY T.START_TIME DESC;

--4.正逆向订单
SELECT *
  FROM W_ETL_LOG T
 WHERE T.PROC_NAME IN ('createfactordergoodsreverse',
                       'createordergoods',
                       'processupdateorder',
                       'processupdateorderreverse')
 ORDER BY T.START_TIME DESC;

--5.
--检查ODS_ORDER是否重复
SELECT /*+PARALLEL(16)*/
 A.CRM_OBJ_ID,
 A.CRM_NUMINT,
 A.ZEAMC008,
 A.CRM_OHGUID,
 A.CRM_ITMGUI,
 A.CRM_PRCTYP,
 A.ZCRMD023,
 A.CRM_ITMTYP,
 A.ZTCMC002,
 A.ZTCMC006,
 A.SALESORG,
 A.DISTR_CHAN,
 A.SALES_OFF,
 A.DIVISION,
 A.ZMATERIAL,
 A.ZEAMC027,
 A.ZLIFNR,
 A.CRM_ENDCST,
 A.ZTCMC016,
 A.AGE,
 A.ZTCMC020,
 A.CRM_SOLDTO,
 A.ZKUNNR_L1,
 A.ZKUNNR_L2,
 A.ZTHRC015,
 A.BP_EMPLO,
 A.ZTHRC016,
 A.ZTHRC017,
 A.ZESDC113,
 A.CRMPOSTDAT,
 A.ZPST_TIM,
 A.ZGZ_TIME,
 A.ZCRMD001,
 A.CRM_USSTAT,
 A.CRM_STSMA,
 A.CRM_CTD_BY,
 A.CRM_CRD_AT,
 A.CREA_TIME,
 A.ZEAMC001,
 A.ZEAMC010,
 A.ZEAMC011,
 A.ZEAMC012,
 A.ZEAMC037,
 A.ZEAMC013,
 A.ZEAMC014,
 A.ZTCMC021,
 A.ZTCMC022,
 A.ZTCMC027,
 A.ZTCMC026,
 A.ZTCMC030,
 A.ZTCMC007,
 A.ZTCMC008,
 A.ZTCMC009,
 A.ZTCMC023,
 A.ZTCMC024,
 A.ZTCMC025,
 A.ZCRMD015,
 A.ZCRMD016,
 A.ZCRMD017,
 A.ZCRMD018,
 A.ZCR_ON,
 A.ZOBJ_CC,
 A.ZDSXD,
 A.ZJSJF_YN,
 A.ZCRMD025,
 A.ZCRMD020,
 A.ZCRMD021,
 A.ZTCRMC01,
 A.ZTCRMC02,
 A.ZTCRMC03,
 A.ZTCRMC04,
 A.ZTCRMC05,
 A.NETVALORD,
 A.CRM_TAXAMO,
 A.GRSVALORD,
 A.ZAMK0011,
 A.ZAMK0010,
 A.ZCRMK006,
 A.ZCRMK007,
 A.ZCRMK009,
 A.CRM_SRVKB,
 A.ZCRMK003,
 A.ZCRMK004,
 A.ZCRMK005,
 A.ZYF_PAY,
 A.ZXY_PAY,
 A.ZNPT_ATM,
 A.CRM_NUMOFI,
 A.ZAMK0024,
 A.ZCRMK008,
 A.SALES_UNIT,
 A.CURRENCY,
 A.CRM_CURREN,
 A.ZCRMD031,
 A.ZEHRC012,
 A.ZCRMD048,
 A.ZCRMD086,
 A.ZCRMD019,
 A.ZTHRC027,
 A.ZTHRC026,
 A.ZTHRC025,
 A.ZTCRMC11,
 A.ZCRMD199,
 A.ZTLEC001,
 A.ZCONDK001,
 A.ZCRMD120,
 A.CHANGED_BY,
 A.ZMATER2,
 A.ZZTRANSF,
 A.ZTMSTAMP,
 COUNT(1)
  FROM ODSHAPPIGO.ODS_ORDER A
 WHERE A.CRMPOSTDAT = TO_CHAR(TRUNC(SYSDATE - 1), 'YYYYMMDD')
 GROUP BY A.CRM_OBJ_ID,
          A.CRM_NUMINT,
          A.ZEAMC008,
          A.CRM_OHGUID,
          A.CRM_ITMGUI,
          A.CRM_PRCTYP,
          A.ZCRMD023,
          A.CRM_ITMTYP,
          A.ZTCMC002,
          A.ZTCMC006,
          A.SALESORG,
          A.DISTR_CHAN,
          A.SALES_OFF,
          A.DIVISION,
          A.ZMATERIAL,
          A.ZEAMC027,
          A.ZLIFNR,
          A.CRM_ENDCST,
          A.ZTCMC016,
          A.AGE,
          A.ZTCMC020,
          A.CRM_SOLDTO,
          A.ZKUNNR_L1,
          A.ZKUNNR_L2,
          A.ZTHRC015,
          A.BP_EMPLO,
          A.ZTHRC016,
          A.ZTHRC017,
          A.ZESDC113,
          A.CRMPOSTDAT,
          A.ZPST_TIM,
          A.ZGZ_TIME,
          A.ZCRMD001,
          A.CRM_USSTAT,
          A.CRM_STSMA,
          A.CRM_CTD_BY,
          A.CRM_CRD_AT,
          A.CREA_TIME,
          A.ZEAMC001,
          A.ZEAMC010,
          A.ZEAMC011,
          A.ZEAMC012,
          A.ZEAMC037,
          A.ZEAMC013,
          A.ZEAMC014,
          A.ZTCMC021,
          A.ZTCMC022,
          A.ZTCMC027,
          A.ZTCMC026,
          A.ZTCMC030,
          A.ZTCMC007,
          A.ZTCMC008,
          A.ZTCMC009,
          A.ZTCMC023,
          A.ZTCMC024,
          A.ZTCMC025,
          A.ZCRMD015,
          A.ZCRMD016,
          A.ZCRMD017,
          A.ZCRMD018,
          A.ZCR_ON,
          A.ZOBJ_CC,
          A.ZDSXD,
          A.ZJSJF_YN,
          A.ZCRMD025,
          A.ZCRMD020,
          A.ZCRMD021,
          A.ZTCRMC01,
          A.ZTCRMC02,
          A.ZTCRMC03,
          A.ZTCRMC04,
          A.ZTCRMC05,
          A.NETVALORD,
          A.CRM_TAXAMO,
          A.GRSVALORD,
          A.ZAMK0011,
          A.ZAMK0010,
          A.ZCRMK006,
          A.ZCRMK007,
          A.ZCRMK009,
          A.CRM_SRVKB,
          A.ZCRMK003,
          A.ZCRMK004,
          A.ZCRMK005,
          A.ZYF_PAY,
          A.ZXY_PAY,
          A.ZNPT_ATM,
          A.CRM_NUMOFI,
          A.ZAMK0024,
          A.ZCRMK008,
          A.SALES_UNIT,
          A.CURRENCY,
          A.CRM_CURREN,
          A.ZCRMD031,
          A.ZEHRC012,
          A.ZCRMD048,
          A.ZCRMD086,
          A.ZCRMD019,
          A.ZTHRC027,
          A.ZTHRC026,
          A.ZTHRC025,
          A.ZTCRMC11,
          A.ZCRMD199,
          A.ZTLEC001,
          A.ZCONDK001,
          A.ZCRMD120,
          A.CHANGED_BY,
          A.ZMATER2,
          A.ZZTRANSF,
          A.ZTMSTAMP
HAVING COUNT(1) > 1;
