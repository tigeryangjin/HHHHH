--1.
SELECT A.SALES_SOURCE_SECOND_NAME,
       SUM(A.EFFECTIVE_ORDER_AMOUNT) EFFECTIVE_ORDER_AMOUNT
  FROM OPER_PRODUCT_DAILY_REPORT A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.SALES_SOURCE_NAME = '电商'
 GROUP BY A.SALES_SOURCE_SECOND_NAME;

--2.
SELECT A.ITEM_CODE, SUM(A.EFFECTIVE_ORDER_AMOUNT) EFFECTIVE_ORDER_AMOUNT
  FROM OPER_PRODUCT_DAILY_REPORT A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.SALES_SOURCE_SECOND_NAME = '新媒体APP（2.0）'
 GROUP BY A.ITEM_CODE
 ORDER BY A.ITEM_CODE;

--******************************************************
--236504
--总订购数量：10-13509
--取消数量：3-4142
--退货数量：1-1279
--******************************************************
--3.
SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.SALES_SOURCE_SECOND_NAME = '新媒体APP（2.0）'
   AND A.ITEM_CODE = 236504;

--4.
SELECT *
  FROM FACT_GOODS_SALES A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.GOODS_COMMON_KEY = 236504
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--5.
SELECT *
  FROM FACT_GOODS_SALES_REVERSE A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.GOODS_COMMON_KEY = 236504
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--******************************************************
--232898
--******************************************************
--3.
SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.SALES_SOURCE_SECOND_NAME = '新媒体APP（2.0）'
   AND A.ITEM_CODE = 232898;

--4.
SELECT *
  FROM FACT_GOODS_SALES A
 WHERE (A.POSTING_DATE_KEY = 20180619 OR A.UPDATE_TIME = 20180619)
   AND A.GOODS_COMMON_KEY = 232898
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--5.
SELECT *
  FROM FACT_GOODS_SALES_REVERSE A
 WHERE (A.POSTING_DATE_KEY = 20180619 OR A.UPDATE_TIME = 20180619)
   AND A.GOODS_COMMON_KEY = 232898
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--6.
SELECT *
  FROM ODSHAPPIGO.ODS_ORDER A
 WHERE A.ZTCRMC04 = 5208829060
   AND A.ZMATER2 = '000000000000232898'
 ORDER BY A.CRM_OBJ_ID;

--7.
SELECT *
  FROM odshappigo.sap_bic_aztcrd00100 A
 WHERE A.CRM_OHGUID = 20180613753314;

--8.
SELECT * FROM ODSHAPPIGO.OD_ORDER_ITEM A WHERE A.ORDER_NO = 20180619814529;

--**********************************************************
--fix
--**********************************************************
--1.ODS_ORDER重复
SELECT A.CRM_ITMGUI, COUNT(1)
  FROM ODSHAPPIGO.ODS_ORDER A
 GROUP BY A.CRM_ITMGUI
HAVING COUNT(1) > 1
 ORDER BY A.CRM_ITMGUI;

SELECT *
  FROM ODSHAPPIGO.ODS_ORDER A
 WHERE A.CRM_ITMGUI = '20180607818196HM3017';

--2.
TRUNCATE TABLE YANGJIN.ODS_ORDER_DUPLICATE2;

INSERT INTO YANGJIN.ODS_ORDER_DUPLICATE2
  (CRM_ITMGUI)
  SELECT A.CRM_ITMGUI
    FROM ODSHAPPIGO.ODS_ORDER A
   GROUP BY A.CRM_ITMGUI
  HAVING COUNT(1) > 1
   ORDER BY A.CRM_ITMGUI;
COMMIT;

SELECT COUNT(1), COUNT(1) / 23224
  FROM YANGJIN.ODS_ORDER_DUPLICATE2 A
 WHERE A.IS_DEL IS NOT NULL;

--3.
DECLARE
  IN_DATE_INT NUMBER(8);
  IN_DATE     DATE;
  BEGIN_DATE  DATE := DATE '2018-06-15';
  END_DATE    DATE := DATE '2018-06-19';
BEGIN
  IN_DATE := BEGIN_DATE;
  WHILE IN_DATE <= END_DATE LOOP
    IN_DATE_INT := TO_CHAR(IN_DATE, 'YYYYMMDD');
    YANGJIN_PKG.FACT_GOODS_SALES_FIX(IN_DATE_INT, 'FACT');
		YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(IN_DATE_INT);
    IN_DATE := IN_DATE + 1;
  END LOOP;
END;
/


--******************************************************
--216186
--******************************************************
--3.
SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.SALES_SOURCE_SECOND_NAME = '新媒体APP（2.0）'
   AND A.ITEM_CODE = 216186;

--4.
SELECT *
  FROM FACT_GOODS_SALES A
 WHERE (A.POSTING_DATE_KEY = 20180619 OR A.UPDATE_TIME = 20180619)
   AND A.GOODS_COMMON_KEY = 216186
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--5.
SELECT *
  FROM FACT_GOODS_SALES_REVERSE A
 WHERE (A.POSTING_DATE_KEY = 20180619 OR A.UPDATE_TIME = 20180619)
   AND A.GOODS_COMMON_KEY = 216186
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--6.
SELECT *
  FROM ODSHAPPIGO.ODS_ORDER A
 WHERE A.CRMPOSTDAT = 20180619
   AND A.ZMATER2 = '000000000000216186'
 ORDER BY A.CRM_OBJ_ID;

--7.
SELECT *
  FROM odshappigo.sap_bic_aztcrd00100 A
 WHERE A.CRMPOSTDAT = 20180619
   AND A."/BIC/ZMATER2" = '000000000000216186';

--8.
SELECT *
  FROM ODSHAPPIGO.OD_ORDER_ITEM A
 WHERE TRUNC(A.ORDER_DATE) = DATE '2018-06-19'
   AND A.ITEM_CODE = 216186;

--******************************************************
--234755
--******************************************************
--3.
SELECT *
  FROM OPER_PRODUCT_DAILY_REPORT A
 WHERE A.POSTING_DATE_KEY = 20180619
   AND A.SALES_SOURCE_SECOND_NAME = '新媒体APP（2.0）'
   AND A.ITEM_CODE = 234755;

--4.
SELECT *
  FROM FACT_GOODS_SALES A
 WHERE (A.POSTING_DATE_KEY = 20180619 OR A.UPDATE_TIME = 20180619)
   AND A.GOODS_COMMON_KEY = 234755
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--5.
SELECT *
  FROM FACT_GOODS_SALES_REVERSE A
 WHERE (A.POSTING_DATE_KEY = 20180619 OR A.UPDATE_TIME = 20180619)
   AND A.GOODS_COMMON_KEY = 234755
   AND A.SALES_SOURCE_SECOND_DESC = 'A20017';

--6.
SELECT *
  FROM ODSHAPPIGO.ODS_ORDER A
 WHERE A.CRMPOSTDAT = 20180619
   AND A.ZMATER2 = '000000000000234755'
 ORDER BY A.CRM_OBJ_ID;

--7.
SELECT *
  FROM odshappigo.sap_bic_aztcrd00100 A
 WHERE A.CRMPOSTDAT = 20180619
   AND A."/BIC/ZMATER2" = '000000000000234755';

--8.
SELECT *
  FROM ODSHAPPIGO.OD_ORDER_ITEM A
 WHERE TRUNC(A.ORDER_DATE) = DATE '2018-06-19'
   AND A.ITEM_CODE = 234755;
	 
--*********************************************************************
--fix2
--*********************************************************************
BEGIN
  YANGJIN_PKG.FACT_GOODS_SALES_FIX(20180619, 'FACT');
  YANGJIN_PKG.OPER_PRODUCT_DAILY_RPT(20180619);
END;
/
