/*
1-8月订购服装大于等于2次的用户
*/
--订购
SELECT F.MEMBER_BP
  FROM (SELECT TO_NUMBER(A.CUST_NO) MEMBER_BP,
               COUNT(DISTINCT A.ORDER_ID) ORDER_CNT
          FROM FACT_EC_ORDER_2 A, FACT_EC_ORDER_GOODS B
         WHERE A.ORDER_ID = B.ORDER_ID
           AND A.ADD_TIME BETWEEN DATE '2018-01-01' AND DATE
         '2018-08-31'
           AND A.ORDER_STATE >= 20
           AND A.CUST_NO <> 0
           AND EXISTS
         (SELECT 1
                  FROM (SELECT D.GOODS_COMMONID
                          FROM DIM_EC_GOOD D, DIM_GOOD_CLASS E
                         WHERE D.MATDL = E.MATDL
                           AND E.MATDL = 11) C
                 WHERE B.GOODS_COMMONID = C.GOODS_COMMONID)
         GROUP BY A.CUST_NO) F
--WHERE F.ORDER_CNT >= 2
 ORDER BY F.MEMBER_BP;

/*
6-9月的活跃用户
*/
SELECT B.MEMBER_KEY, COUNT(B.VISIT_DATE_KEY) VISIT_DATE_CNT
  FROM (SELECT DISTINCT A.VISIT_DATE_KEY, A.MEMBER_KEY
          FROM FACT_PAGE_VIEW A
         WHERE A.VISIT_DATE_KEY BETWEEN 20180601 AND 20180930
           AND A.MEMBER_KEY <> 0) B
 GROUP BY B.MEMBER_KEY
 ORDER BY COUNT(B.VISIT_DATE_KEY) DESC;

/*
1-9月浏览过生活家电的用户
*/
--浏览临时表
CREATE TABLE YANGJIN.FACT_PAGE_VIEW_2018_1_9 AS
  SELECT /*+PARALLEL(8)*/
  DISTINCT A.VISIT_DATE_KEY, A.MEMBER_KEY, A.PAGE_VALUE
    FROM FACT_PAGE_VIEW A
   WHERE A.VISIT_DATE_KEY BETWEEN 20180101 AND 20180831
     AND A.PAGE_NAME IN ('good', 'Good')
     AND A.MEMBER_KEY <> 0
     AND A.PAGE_VALUE =
         TRANSLATE(A.PAGE_VALUE,
                   '0' || TRANSLATE(A.PAGE_VALUE, '#0123456789', '#'),
                   '0');
--浏览
SELECT TO_NUMBER(A.MEMBER_KEY) MEMBER_BP,
       COUNT(DISTINCT A.PAGE_VALUE) ITEM_CNT
  FROM YANGJIN.FACT_PAGE_VIEW_2018_1_9 A
 WHERE A.VISIT_DATE_KEY BETWEEN 20180101 AND 20180930
   AND A.MEMBER_KEY <> 0
   AND a.page_value =
       translate(a.page_value,
                 '0' || translate(a.page_value, '#0123456789', '#'),
                 '0')
   AND EXISTS (SELECT 1
          FROM (SELECT D.GOODS_COMMONID
                  FROM DIM_EC_GOOD D, DIM_GOOD_CLASS E
                 WHERE D.MATDL = E.MATDL
                   AND E.MATXL = 430202) B
         WHERE A.PAGE_VALUE = B.GOODS_COMMONID)
 GROUP BY TO_NUMBER(A.MEMBER_KEY)
 ORDER BY COUNT(DISTINCT A.PAGE_VALUE) DESC;

/*
1-9月浏览过洗衣机但未订购洗衣机的用户
*/
--浏览
SELECT TO_NUMBER(A.MEMBER_KEY) MEMBER_BP,
       COUNT(DISTINCT A.PAGE_VALUE) ITEM_CNT
  FROM YANGJIN.FACT_PAGE_VIEW_2018_1_9 A
 WHERE A.VISIT_DATE_KEY BETWEEN 20180101 AND 20180930
   AND A.MEMBER_KEY <> 0
   AND a.page_value =
       translate(a.page_value,
                 '0' || translate(a.page_value, '#0123456789', '#'),
                 '0')
   AND EXISTS (SELECT 1
          FROM (SELECT D.GOODS_COMMONID
                  FROM DIM_EC_GOOD D, DIM_GOOD_CLASS E
                 WHERE D.MATDL = E.MATDL
                   AND E.MATXL = 430103) B
         WHERE A.PAGE_VALUE = B.GOODS_COMMONID)
 GROUP BY TO_NUMBER(A.MEMBER_KEY)
 ORDER BY COUNT(DISTINCT A.PAGE_VALUE) DESC;
--订购
SELECT F.MEMBER_BP
  FROM (SELECT TO_NUMBER(A.CUST_NO) MEMBER_BP,
               COUNT(DISTINCT A.ORDER_ID) ORDER_CNT
          FROM FACT_EC_ORDER_2 A, FACT_EC_ORDER_GOODS B
         WHERE A.ORDER_ID = B.ORDER_ID
           AND A.ADD_TIME BETWEEN DATE '2018-01-01' AND DATE
         '2018-09-30'
           AND A.ORDER_STATE >= 20
           AND A.CUST_NO <> 0
           AND EXISTS
         (SELECT 1
                  FROM (SELECT D.GOODS_COMMONID
                          FROM DIM_EC_GOOD D, DIM_GOOD_CLASS E
                         WHERE D.MATDL = E.MATDL
                           AND E.MATXL = 430103) C
                 WHERE B.GOODS_COMMONID = C.GOODS_COMMONID)
         GROUP BY A.CUST_NO) F
 ORDER BY F.MEMBER_BP;

/*
1-9月浏览过冰箱但未订购冰箱的用户
*/
--浏览
SELECT TO_NUMBER(A.MEMBER_KEY) MEMBER_BP,
       COUNT(DISTINCT A.PAGE_VALUE) ITEM_CNT
  FROM YANGJIN.FACT_PAGE_VIEW_2018_1_9 A
 WHERE A.VISIT_DATE_KEY BETWEEN 20180101 AND 20180930
   AND A.MEMBER_KEY <> 0
   AND a.page_value =
       translate(a.page_value,
                 '0' || translate(a.page_value, '#0123456789', '#'),
                 '0')
   AND EXISTS (SELECT 1
          FROM (SELECT D.GOODS_COMMONID
                  FROM DIM_EC_GOOD D, DIM_GOOD_CLASS E
                 WHERE D.MATDL = E.MATDL
                   AND E.MATXL = 430101) B
         WHERE A.PAGE_VALUE = B.GOODS_COMMONID)
 GROUP BY TO_NUMBER(A.MEMBER_KEY)
 ORDER BY COUNT(DISTINCT A.PAGE_VALUE) DESC;
--订购
SELECT F.MEMBER_BP
  FROM (SELECT TO_NUMBER(A.CUST_NO) MEMBER_BP,
               COUNT(DISTINCT A.ORDER_ID) ORDER_CNT
          FROM FACT_EC_ORDER_2 A, FACT_EC_ORDER_GOODS B
         WHERE A.ORDER_ID = B.ORDER_ID
           AND A.ADD_TIME BETWEEN DATE '2018-01-01' AND DATE
         '2018-09-30'
           AND A.ORDER_STATE >= 20
           AND A.CUST_NO <> 0
           AND EXISTS
         (SELECT 1
                  FROM (SELECT D.GOODS_COMMONID
                          FROM DIM_EC_GOOD D, DIM_GOOD_CLASS E
                         WHERE D.MATDL = E.MATDL
                           AND E.MATXL = 430101) C
                 WHERE B.GOODS_COMMONID = C.GOODS_COMMONID)
         GROUP BY A.CUST_NO) F
 ORDER BY F.MEMBER_BP;


--TMP
SELECT * FROM DIM_GOOD_CLASS A WHERE A.MATDLT LIKE '%冰箱%';
SELECT * FROM DIM_GOOD_CLASS A WHERE A.MATZLT LIKE '%冰箱%';
SELECT * FROM DIM_GOOD_CLASS A WHERE A.MATXLT LIKE '%冰箱%';
SELECT * FROM DIM_GOOD_CLASS A WHERE A.Matklt LIKE '%冰箱%';
