SELECT ORD.MEMBER_KEY,
       MLH.M_LABEL_ID,
       MLH.M_LABEL_TYPE_ID,
       SYSDATE CREATE_DATE,
       'yangjin' CREATE_USER_ID,
       SYSDATE LAST_UPDATE_DATE,
       'yangjin' LAST_UPDATE_USER_ID
  FROM (SELECT A.MEMBER_KEY,
               A.ORDER_KEY,
               MIN(A.GOODS_COMMON_KEY) GOODS_COMMON_KEY,
               A.ORDER_AMOUNT
          FROM FACT_GOODS_SALES A
         WHERE A.ORDER_STATE = 1
           AND A.GOODS_COMMON_KEY IS NOT NULL
           AND EXISTS
         (SELECT 1
                  FROM (SELECT C.MEMBER_KEY, MIN(C.ORDER_KEY) ORDER_KEY
                          FROM FACT_GOODS_SALES C
                         WHERE C.ORDER_STATE = 1
                           AND C.GOODS_COMMON_KEY IS NOT NULL
                         GROUP BY C.MEMBER_KEY) B
                 WHERE A.MEMBER_KEY = B.MEMBER_KEY
                   AND A.ORDER_KEY = B.ORDER_KEY)
           AND EXISTS (SELECT 1
                  FROM (SELECT C.MEMBER_KEY,
                               C.ORDER_KEY,
                               MAX(C.ORDER_AMOUNT) ORDER_AMOUNT
                          FROM FACT_GOODS_SALES C
                         WHERE C.ORDER_STATE = 1
                           AND C.GOODS_COMMON_KEY IS NOT NULL
                         GROUP BY C.MEMBER_KEY, C.ORDER_KEY) D
                 WHERE A.MEMBER_KEY = D.MEMBER_KEY
                   AND A.ORDER_KEY = D.ORDER_KEY
                   AND A.ORDER_AMOUNT = D.ORDER_AMOUNT)
           AND A.MEMBER_KEY = 1617021130
         GROUP BY A.MEMBER_KEY, A.ORDER_KEY, A.ORDER_AMOUNT) ORD,
       /*商品标签分类*/
       (SELECT A.ITEM_CODE,
               CASE
                 WHEN A.GROUP_ID = 1000 AND EXISTS
                  (SELECT 1
                         FROM DIM_TV_GOOD B
                        WHERE A.ITEM_CODE = B.ITEM_CODE) THEN
                  'FIRST_ORDER_BROADCAST'
                 WHEN A.GROUP_ID = 1000 THEN
                  'FIRST_ORDER_NOT_BROADCAST'
                 WHEN A.GROUP_ID = 2000 AND EXISTS
                  (SELECT 1
                         FROM DIM_EC_GOOD C
                        WHERE A.ITEM_CODE = C.ITEM_CODE
                          AND C.STORE_ID = 1) THEN
                  'FIRST_ORDER_SELF'
                 WHEN A.GROUP_ID = 2000 AND EXISTS
                  (SELECT 1
                         FROM DIM_EC_GOOD C
                        WHERE A.ITEM_CODE = C.ITEM_CODE
                          AND C.STORE_ID <> 1) THEN
                  'FIRST_ORDER_BBC'
                 ELSE
                  'FIRST_ORDER_OTHER'
               END ITEM_LABEL
          FROM DIM_GOOD A
         WHERE A.CURRENT_FLG = 'Y') ITEM,
       (SELECT * FROM MEMBER_LABEL_HEAD) MLH
 WHERE ORD.GOODS_COMMON_KEY = ITEM.ITEM_CODE
   AND ITEM.ITEM_LABEL = MLH.M_LABEL_NAME
      /*不存在MEMBER_LABEL_LINK表的插入*/
   AND NOT EXISTS (SELECT 1
          FROM MEMBER_LABEL_LINK MLL
         WHERE MLL.M_LABEL_ID BETWEEN 42 AND 47
           AND ORD.MEMBER_KEY = MLL.MEMBER_KEY);

SELECT A.ITEM_CODE,
       CASE
         WHEN A.GROUP_ID = 1000 AND EXISTS
          (SELECT 1 FROM DIM_TV_GOOD B WHERE A.ITEM_CODE = B.ITEM_CODE) THEN
          'FIRST_ORDER_BROADCAST'
         WHEN A.GROUP_ID = 1000 THEN
          'FIRST_ORDER_NOT_BROADCAST'
         WHEN A.GROUP_ID = 2000 AND EXISTS (SELECT 1
                 FROM DIM_EC_GOOD C
                WHERE A.ITEM_CODE = C.ITEM_CODE
                  AND C.STORE_ID = 1) THEN
          'FIRST_ORDER_SELF'
         WHEN A.GROUP_ID = 2000 AND EXISTS (SELECT 1
                 FROM DIM_EC_GOOD C
                WHERE A.ITEM_CODE = C.ITEM_CODE
                  AND C.STORE_ID <> 1) THEN
          'FIRST_ORDER_BBC'
         ELSE
          'FIRST_ORDER_OTHER'
       END ITEM_LABEL
  FROM DIM_GOOD A
 WHERE A.CURRENT_FLG = 'Y'
   AND A.ITEM_CODE = 226697;

SELECT * FROM DIM_GOOD A WHERE A.ITEM_CODE=226697 AND A.CURRENT_FLG='Y';

SELECT DISTINCT A.GROUP_ID,A.GROUP_NAME FROM DIM_GOOD A WHERE A.CURRENT_FLG='Y';

begin
  -- Call the procedure
  member_label_pkg.create_member_label(in_m_label_name      => 'FIRST_ORDER_JD',
                                       in_m_label_desc      => '首单为京东商品',
                                       in_m_label_type_id   => 1,
                                       in_m_label_father_id => 41);
end;
/
