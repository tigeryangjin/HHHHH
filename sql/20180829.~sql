/*
20180801-20180828  本月浏览及订购过的白金及以上用户
  本月多次加入购物车未生成订单，生成订单未支付的用户
*/
--本月浏览及订购过的白金及以上用户
SELECT DISTINCT A.MEMBER_KEY
  FROM FACT_SESSION A
 WHERE A.START_DATE_KEY BETWEEN 20180801 AND 20180828
   AND A.MEMBER_KEY <> 0
   AND EXISTS
 (SELECT 1
          FROM DIM_MEMBER B
         WHERE A.MEMBER_KEY = B.MEMBER_BP
           AND B.MEMBER_LEVEL IN ('HAPP_T4', 'HAPP_T5', 'HAPP_T6'))
 ORDER BY A.MEMBER_KEY;

--本月多次加入购物车未生成订单，生成订单未支付的用户
SELECT DISTINCT TO_NUMBER(A.MEMBER_KEY) MEMBER_KEY
  FROM FACT_SHOPPINGCAR A
 WHERE A.CREATE_DATE_KEY BETWEEN 20180801 AND 20180828
   AND A.MEMBER_KEY <> 0
   AND NOT EXISTS
 (SELECT 1
          FROM FACT_EC_ORDER_2 B
         WHERE A.MEMBER_KEY = B.CUST_NO
           AND TO_CHAR(B.ADD_TIME, 'YYYYMMDD') BETWEEN 20180801 AND 20180828)
UNION
SELECT DISTINCT TO_NUMBER(C.CUST_NO) MEMBER_KEY
  FROM FACT_EC_ORDER_2 C
 WHERE TO_CHAR(C.ADD_TIME, 'YYYYMMDD') BETWEEN 20180801 AND 20180828
   AND C.ORDER_STATE < 20;

--购物车商品均价
TRUNCATE TABLE YANGJIN.MEMBER_TMP;
SELECT * FROM YANGJIN.MEMBER_TMP FOR UPDATE;

SELECT A5.MEMBER_KEY, ROUND(SUM(A5.AMOUNT) / COUNT(A5.ITEM_CODE), 2) AVG_AMOUNT
  FROM (SELECT A3.MEMBER_KEY, A4.ITEM_CODE, A4.GOOD_PRICE * A3.QTY AMOUNT
          FROM (SELECT A1.MEMBER_KEY,
                       A1.SCGID GOODS_COMMONID,
                       SUM(A1.SCGQ) QTY
                  FROM FACT_SHOPPINGCAR A1
                 WHERE EXISTS (SELECT 1
                          FROM YANGJIN.MEMBER_TMP A2
                         WHERE A1.MEMBER_KEY = A2.MEMBER_KEY)
                 GROUP BY A1.MEMBER_KEY, A1.SCGID) A3,
               DIM_GOOD A4
         WHERE A3.GOODS_COMMONID = A4.GOODS_COMMONID
           AND A4.GOOD_PRICE * A3.QTY <> 0
           AND A3.QTY > 0) A5
 GROUP BY A5.MEMBER_KEY
 ORDER BY A5.MEMBER_KEY;

--tmp
SELECT * FROM FACT_SHOPPINGCAR A WHERE A.MEMBER_KEY = 603000279;
SELECT DISTINCT A.MEMBER_LEVEL FROM DIM_MEMBER A;
SELECT * FROM DIM_EC_GOOD;
SELECT *
  FROM DIM_GOOD A
 WHERE A.GOODS_COMMONID IN (166918, 166918, 164843, 340558);
