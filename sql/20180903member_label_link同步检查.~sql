SELECT COUNT(1) FROM MLOG$_MEMBER_LABEL_LINK;

SELECT * FROM MEMBER_LABEL_LINK A;
SELECT * FROM MEMBER_LABEL_LINK@ML18;

--≤Ó“Ï
WITH MA AS
 (SELECT A.M_LABEL_ID, COUNT(1) S_CNT
    FROM MEMBER_LABEL_LINK A
   GROUP BY A.M_LABEL_ID
   ORDER BY A.M_LABEL_ID),
MB AS
 (SELECT A.M_LABEL_ID, COUNT(1) T_CNT
    FROM MEMBER_LABEL_LINK@ML18 A
   GROUP BY A.M_LABEL_ID
   ORDER BY A.M_LABEL_ID)
SELECT MA.M_LABEL_ID, MA.S_CNT, MB.T_CNT, MA.S_CNT - MB.T_CNT DF_CNT
  FROM MA, MB
 WHERE MA.M_LABEL_ID = MB.M_LABEL_ID(+);

SELECT * FROM MEMBER_LABEL_LINK A WHERE A.M_LABEL_ID IS NULL;

SELECT COUNT(1) FROM MEMBER_LABEL_LINK A WHERE A.M_LABEL_ID = 3;
SELECT COUNT(1) FROM MEMBER_LABEL_LINK@ML18 A WHERE A.M_LABEL_ID = 3;

SELECT *
  FROM MEMBER_LABEL_LINK A
 WHERE A.M_LABEL_ID = 403
 ORDER BY A.MEMBER_KEY;
SELECT *
  FROM MEMBER_LABEL_LINK@ML18 A
 WHERE A.M_LABEL_ID = 403
 ORDER BY A.MEMBER_KEY;

/*
122
123
124
125
*/
DECLARE
  TYPE TYPE_ARRAYS IS RECORD(
    M_LABEL_ID NUMBER(10));
  TYPE TYPE_ARRAY IS TABLE OF TYPE_ARRAYS INDEX BY BINARY_INTEGER;
  VAR_ARRAY TYPE_ARRAY;
BEGIN
  SELECT P.*
    BULK COLLECT
    INTO VAR_ARRAY
    FROM (SELECT A.M_LABEL_ID
            FROM MEMBER_LABEL_HEAD A
           WHERE A.M_LABEL_ID IN (715, 716)) P;
  FOR I IN 1 .. VAR_ARRAY.COUNT LOOP
    UPDATE MEMBER_LABEL_LINK A
       SET A.LAST_UPDATE_DATE = SYSDATE
     WHERE NOT EXISTS (SELECT 1
              FROM MEMBER_LABEL_LINK@ML18 B
             WHERE A.MEMBER_KEY = B.MEMBER_KEY
               AND B.M_LABEL_ID = VAR_ARRAY(I).M_LABEL_ID)
       AND A.M_LABEL_ID = VAR_ARRAY(I).M_LABEL_ID;
    COMMIT;
  END LOOP;
END;


UPDATE MEMBER_LABEL_LINK A
   SET A.LAST_UPDATE_DATE = A.LAST_UPDATE_DATE
 WHERE TRUNC(A.LAST_UPDATE_DATE) = DATE '2018-09-05';
COMMIT;

--
BEGIN
  MEMBER_FILTER_PKG.SYNC_MEMBER_LABEL_LINK;
END;
