TRUNCATE TABLE OPER_NM_PROMOTION_ORDER_REPORT;

--重新刷新历史数据
DECLARE
  IN_DATE_INT NUMBER(8);
  IN_DATE     DATE;
  BEGIN_DATE  DATE := DATE '2017-01-01';
  END_DATE    DATE := DATE '2017-10-09';
BEGIN
  IN_DATE := BEGIN_DATE;
  WHILE IN_DATE <= END_DATE LOOP
    IN_DATE_INT := TO_CHAR(IN_DATE, 'YYYYMMDD');
    YANGJIN_PKG.OPER_NM_PROMOTION_ORDER_RPT(IN_DATE_INT);
    IN_DATE := IN_DATE + 1;
  END LOOP;
END;
/


DROP TABLE OPER_NM_PROMOTION_ORDER_TEST;

SELECT * FROM FACT_EC_ORDER_2 A WHERE A.ORDER_SN = 270545427256840326;
SELECT * FROM FACT_EC_ORDER_GOODS A WHERE A.ORDER_ID = 1888798;
SELECT * FROM FACT_EC_P_MANSONG A WHERE A.MANSONG_ID = 282;
SELECT * FROM FACT_EC_P_MANSONG_GOODS A WHERE A.MANSONG_ID = 282;

/*DISCOUNT_MANSONG_AMOUNT*/
        SELECT TRUNC(OH.ADD_TIME) ADD_TIME, /*订购日期*/
               TO_CHAR(OH.ORDER_SN) ORDER_SN, /*订单编号*/
               M.MANSONG_NAME PROMOTION_NAME, /*促销名称/券名称*/
               CASE
                 WHEN OH.APP_NAME = 'KLGiPhone' THEN
                  'APP'
                 WHEN OH.APP_NAME = 'KLGAndroid' THEN
                  'APP'
                 WHEN OH.APP_NAME = 'KLGPortal' THEN
                  'WEB'
                 WHEN OH.APP_NAME = 'KLGMPortal' THEN
                  'WEB'
                 WHEN OH.APP_NAME = 'KLGWX' THEN
                  '微信'
                 WHEN OH.APP_NAME = 'undefined' THEN
                  '未知'
               END PATHWAY, /*通路*/
               '满立减' PROMONTION_TYPE, /*促销类型*/
               OH.ORDER_AMOUNT SALES_AMOUNT, /*商品有效金额*/
               OH.DISCOUNT_MANSONG_AMOUNT /*促销金额*/
          FROM FACT_EC_ORDER_2         OH,
               FACT_EC_P_MANSONG       M
         WHERE OH.DISCOUNT_MANSONG_ID = M.MANSONG_ID
              /*有效订购条件*/
           AND OH.ORDER_STATE >= 30
           AND OH.REFUND_STATE = 0
           AND OH.DISCOUNT_MANSONG_AMOUNT <> 0
   --AND TRUNC(OH.ADD_TIME) = IN_POSTING_DATE
	 AND OH.ORDER_SN=270545427256840326;


/*DISCOUNT_MANSONG_AMOUNT*/
SELECT TRUNC(OH.ADD_TIME) ADD_TIME, /*订购日期*/
       TO_CHAR(OH.ORDER_SN) ORDER_SN, /*订单编号*/
       M.MANSONG_NAME PROMOTION_NAME, /*促销名称/券名称*/
       CASE
         WHEN OH.APP_NAME = 'KLGiPhone' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGAndroid' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGMPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGWX' THEN
          '微信'
         WHEN OH.APP_NAME = 'undefined' THEN
          '未知'
       END PATHWAY, /*通路*/
       '满立减' PROMONTION_TYPE, /*促销类型*/
       SUM(OG.GOODS_NUM * OG.GOODS_PAY_PRICE) SALES_AMOUNT, /*商品有效金额*/
       OH.DISCOUNT_MANSONG_AMOUNT /*促销金额*/
  FROM FACT_EC_ORDER_2         OH,
       FACT_EC_ORDER_GOODS     OG,
       FACT_EC_P_MANSONG       M,
       FACT_EC_P_MANSONG_GOODS MG
 WHERE OH.ORDER_ID = OG.ORDER_ID
   AND OH.DISCOUNT_MANSONG_ID = M.MANSONG_ID
   AND M.MANSONG_ID = MG.MANSONG_ID
   AND MG.GOODS_ID = OG.GOODS_ID
      /*有效订购条件*/
   AND OH.ORDER_STATE >= 30
   AND OH.REFUND_STATE = 0
   AND OH.DISCOUNT_MANSONG_AMOUNT <> 0
   --AND TRUNC(OH.ADD_TIME) = IN_POSTING_DATE
	 AND OH.ORDER_SN=270545427256840326
 GROUP BY TRUNC(OH.ADD_TIME),
          TO_CHAR(OH.ORDER_SN),
          M.MANSONG_NAME,
          OH.APP_NAME,
          OH.DISCOUNT_MANSONG_AMOUNT;

SELECT A.ORDER_SN, A.PROMONTION_TYPE, COUNT(1)
  FROM OPER_NM_PROMOTION_ORDER_REPORT A
 GROUP BY A.ORDER_SN, A.PROMONTION_TYPE
HAVING COUNT(1) > 1;

SELECT *
  FROM OPER_NM_PROMOTION_ORDER_REPORT A
 WHERE A.ORDER_SN = 270545427256840326;

INSERT INTO OPER_NM_PROMOTION_ORDER_REPORT
  SELECT A.ADD_TIME,
         A.ORDER_SN,
         A.PROMOTION_NAME,
         A.PATHWAY,
         A.PROMONTION_TYPE,
         SUM(A.SALES_AMOUNT),
         A.DISCOUNT_MANSONG_AMOUNT
    FROM OPER_NM_PROMOTION_ORDER_TEST A
   WHERE A.PROMONTION_TYPE = '支付立减'
   GROUP BY A.ADD_TIME,
            A.ORDER_SN,
            A.PROMOTION_NAME,
            A.PATHWAY,
            A.PROMONTION_TYPE,
            A.DISCOUNT_MANSONG_AMOUNT;
COMMIT;

INSERT INTO OPER_NM_PROMOTION_ORDER_REPORT
  SELECT DISTINCT A.ADD_TIME,
                  A.ORDER_SN,
                  A.PROMOTION_NAME,
                  A.PATHWAY,
                  A.PROMONTION_TYPE,
                  A.SALES_AMOUNT,
                  A.DISCOUNT_MANSONG_AMOUNT
    FROM OPER_NM_PROMOTION_ORDER_TEST A
   WHERE A.PROMONTION_TYPE = '满立减';
COMMIT;

SELECT *
  FROM OPER_NM_PROMOTION_ORDER_TEST A
 WHERE A.ORDER_SN = 370558711258509225;

SELECT *
  FROM OPER_NM_PROMOTION_ORDER_TEST A
 WHERE A.ORDER_SN = 570536625098162334;

SELECT DISTINCT A.PROMONTION_TYPE FROM OPER_NM_PROMOTION_ORDER_TEST A;

CREATE TABLE OPER_NM_PROMOTION_ORDER_TEST AS
  SELECT * FROM OPER_NM_PROMOTION_ORDER_REPORT;

TRUNCATE TABLE OPER_NM_PROMOTION_ORDER_REPORT;

--重新刷新历史数据
DECLARE
  IN_DATE_INT NUMBER(8);
  IN_DATE     DATE;
  BEGIN_DATE  DATE := DATE '2017-01-01';
  END_DATE    DATE := DATE '2017-10-09';
BEGIN
  IN_DATE := BEGIN_DATE;
  WHILE IN_DATE <= END_DATE LOOP
    IN_DATE_INT := TO_CHAR(IN_DATE, 'YYYYMMDD');
    YANGJIN_PKG.OPER_NM_PROMOTION_ORDER_RPT(IN_DATE_INT);
    IN_DATE := IN_DATE + 1;
  END LOOP;
END;
/

  SELECT A.ORDER_SN, A.PROMONTION_TYPE, COUNT(1)
    FROM OPER_NM_PROMOTION_ORDER_TEST A
   GROUP BY A.ORDER_SN, A.PROMONTION_TYPE
  HAVING COUNT(1) > 1;

SELECT *
  FROM OPER_NM_PROMOTION_ORDER_REPORT A
 WHERE A.ORDER_SN = 370558711258509225;

SELECT * FROM FACT_EC_ORDER_2 A WHERE A.ORDER_SN = 270545427256840326;
SELECT * FROM FACT_EC_ORDER_GOODS A WHERE A.ORDER_ID = 1888798;
SELECT * FROM FACT_EC_P_MANSONG A WHERE A.MANSONG_ID = 282;
SELECT * FROM FACT_EC_P_MANSONG_GOODS A WHERE A.MANSONG_ID = 282;

SELECT TRUNC(OH.ADD_TIME) ADD_TIME, /*订购日期*/
       TO_CHAR(OH.ORDER_SN) ORDER_SN, /*订单编号*/
       M.MANSONG_NAME PROMOTION_NAME, /*促销名称/券名称*/
       CASE
         WHEN OH.APP_NAME = 'KLGiPhone' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGAndroid' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGMPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGWX' THEN
          '微信'
         WHEN OH.APP_NAME = 'undefined' THEN
          '未知'
       END PATHWAY, /*通路*/
       '满立减' PROMONTION_TYPE, /*促销类型*/
       OG.GOODS_NUM * OG.GOODS_PAY_PRICE SALES_AMOUNT, /*商品有效金额*/
       OH.DISCOUNT_MANSONG_AMOUNT /*促销金额*/
  FROM FACT_EC_ORDER_2         OH,
       FACT_EC_ORDER_GOODS     OG,
       FACT_EC_P_MANSONG       M,
       FACT_EC_P_MANSONG_GOODS MG
 WHERE OH.ORDER_ID = OG.ORDER_ID
   AND OH.DISCOUNT_MANSONG_ID = M.MANSONG_ID
   AND M.MANSONG_ID = MG.MANSONG_ID
   AND MG.GOODS_ID = OG.GOODS_ID
      /*有效订购条件*/
   AND OH.ORDER_STATE >= 30
   AND OH.REFUND_STATE = 0
   AND OH.DISCOUNT_MANSONG_AMOUNT <> 0
      --AND TRUNC(OH.ADD_TIME) = IN_POSTING_DATE
   AND OH.ORDER_SN = 270545427256840326;

/*DISCOUNT_PAYMENTWAY_DESC*/
SELECT TRUNC(OH.ADD_TIME) ADD_TIME, /*订购日期*/
       TO_CHAR(OH.ORDER_SN) ORDER_SN, /*订单编号*/
       OH.DISCOUNT_PAYMENTWAY_DESC, /*促销名称/券名称*/
       CASE
         WHEN OH.APP_NAME = 'KLGiPhone' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGAndroid' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGMPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGWX' THEN
          '微信'
         WHEN OH.APP_NAME = 'undefined' THEN
          '未知'
       END PATHWAY, /*通路*/
       '支付立减' PROMONTION_TYPE, /*促销类型*/
       SUM(OG.GOODS_NUM * OG.GOODS_PAY_PRICE) SALES_AMOUNT, /*商品有效金额*/
       OH.DISCOUNT_PAYMENTWAY_AMOUNT /*促销金额*/
  FROM FACT_EC_ORDER_2 OH, FACT_EC_ORDER_GOODS OG
 WHERE OH.ORDER_ID = OG.ORDER_ID
      /*有效订购条件*/
   AND OH.ORDER_STATE >= 30
   AND OH.REFUND_STATE = 0
   AND OH.DISCOUNT_PAYMENTWAY_AMOUNT <> 0
      --AND TRUNC(OH.ADD_TIME) = IN_POSTING_DATE
   AND OH.ORDER_SN = 430536591149518807
 GROUP BY TRUNC(OH.ADD_TIME),
          TO_CHAR(OH.ORDER_SN),
          OH.DISCOUNT_PAYMENTWAY_DESC,
          OH.APP_NAME,
          OH.DISCOUNT_PAYMENTWAY_AMOUNT;

/*DISCOUNT_PAYMENTCHANEL_DESC*/
SELECT TRUNC(OH.ADD_TIME) ADD_TIME, /*订购日期*/
       TO_CHAR(OH.ORDER_SN) ORDER_SN, /*订单编号*/
       OH.DISCOUNT_PAYMENTCHANEL_DESC, /*促销名称/券名称*/
       CASE
         WHEN OH.APP_NAME = 'KLGiPhone' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGAndroid' THEN
          'APP'
         WHEN OH.APP_NAME = 'KLGPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGMPortal' THEN
          'WEB'
         WHEN OH.APP_NAME = 'KLGWX' THEN
          '微信'
         WHEN OH.APP_NAME = 'undefined' THEN
          '未知'
       END PATHWAY, /*通路*/
       '支付立减' PROMONTION_TYPE, /*促销类型*/
       OG.GOODS_NUM * OG.GOODS_PAY_PRICE SALES_AMOUNT, /*商品有效金额*/
       OH.DISCOUNT_PAYMENTCHANEL_AMOUNT /*促销金额*/
  FROM FACT_EC_ORDER_2 OH, FACT_EC_ORDER_GOODS OG
 WHERE OH.ORDER_ID = OG.ORDER_ID
      /*有效订购条件*/
   AND OH.ORDER_STATE >= 30
   AND OH.REFUND_STATE = 0
   AND OH.DISCOUNT_PAYMENTCHANEL_AMOUNT <> 0
      --AND TRUNC(OH.ADD_TIME) = IN_POSTING_DATE
   AND OH.ORDER_SN = 430536591149518807;
